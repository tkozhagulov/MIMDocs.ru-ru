---
title: Развертывание диспетчера сертификатов MIM | Microsoft Docs
description: Установка диспетчера сертификатов Microsoft Identity Manager 2016
keywords: ''
author: barclayn
ms.author: barclayn
manager: mbaldwin
ms.date: 09/19/2017
ms.topic: article
ms.service: microsoft-identity-manager
ms.technology: security
ms.assetid: ''
ms.openlocfilehash: 241ad68d3f4a692c87d0d2a0069781ad042453c7
ms.sourcegitcommit: 39f34a38967baa9c0da6ae5b57734b222f5771a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2018
---
# <a name="deploying-microsoft-identity-manager-certificate-manager-2016-mim-cm"></a>Развертывание диспетчера сертификатов Microsoft Identity Manager 2016 (MIM CM)

Установка диспетчера сертификатов Microsoft Identity Manager 2016 (MIM CM) включает ряд действий. Чтобы упростить для вас эту процедуру, мы разбили ее на этапы. Существуют предварительные шаги, которые необходимо выполнить до фактического развертывания диспетчера сертификатов MIM. Без этих предварительных действий может произойти сбой установки.

На приведенной ниже схеме показан пример подходящего типа среды. Системы под номерами указаны в списке под схемой. Они необходимы для успешного завершения процедур, описанных в данной статье. Кроме того, используются серверы Windows 2016 Datacenter Server.

![Схема среды](media/mim-cm-deploy/image001.png)

1. CORPDC — контроллер домена
2. CORPCM — сервер диспетчера сертификатов MIM
3. CORPCA — центр сертификации
4. CORPCMR — веб-сервер REST API диспетчера сертификатов MIM — портал диспетчера сертификатов для REST API (используется позднее)
5. CORPSQL1 — SQL 2016 SP1
6. CORPWK1 — присоединен к домену Windows 10

## <a name="deployment-overview"></a>Общие сведения о развертывании

- Установка базовой операционной системы

    Лаборатория состоит из серверов Windows 2016 Datacenter Server.

    >[!NOTE]
    >Дополнительные сведения о поддерживаемых платформах для MIM 2016 см. в статье [Поддерживаемые платформы для MIM 2016](/microsoft-identity-manager/microsoft-identity-manager-2016-supported-platforms.md).

1. Предварительные действия

    - [Расширение схемы](https://msdn.microsoft.com/library/ms676929(v=vs.85).aspx)

    - Создание учетных записей служб

    - [Создание шаблонов сертификатов](https://technet.microsoft.com/library/cc753370(v=ws.11).aspx)

    - IIS

    - Настройка Kerberos

    - Шаги, относящиеся к базе данных

        - Требования к конфигурации SQL

        - Разрешения базы данных

2. Deployment (Развертывание)

## <a name="pre-deployment-steps"></a>Предварительные действия

Мастеру настройки диспетчера сертификатов MIM для успешной работы требуются определенные данные, предоставляемые по мере выполнения.

![Схема](media/mim-cm-deploy/image003.png)

### <a name="extending-the-schema"></a>Расширение схемы

Процесс расширения схемы прост, но требует осторожности, так как по своей природе необратим.

>[!NOTE]
>Для выполнения этого этапа используемой учетной записи должны быть назначены права администратора схемы.

1. Перейдите к носителю MIM, а затем к папке \\Certificate Management\\x64.

2. Скопируйте папку Schema в папку CORPDC, а затем перейдите в эту папку.

    ![Схема](media/mim-cm-deploy/image005.png)

3. Запустите сценарий resourceForestModifySchema.vbs для среды с одним лесом. Для среды с лесом ресурсов выполните следующие сценарии:
    - DomainA — папка Users (userForestModifySchema.vbs);
    - ResourceForestB — расположение установки диспетчера сертификатов (resourceForestModifySchema.vbs).

    >[!NOTE]
    >Изменение схемы — это односторонняя операция, которую можно обратить, только выполнив восстановление леса: убедитесь, что у вас есть необходимые резервные копии. Сведения об изменениях, вносимых в схему при выполнении этой операции, см. в статье [Forefront Identity Manager 2010 Certificate Management Schema Changes](https://technet.microsoft.com/library/jj159298(v=ws.10).aspx).

    ![Схема](media/mim-cm-deploy/image007.png)

4. Выполните сценарий. На экран должно быть выведено сообщение об успешном выполнении.

    ![Сообщение об успешном выполнении](media/mim-cm-deploy/image009.png)

Схема в AD теперь расширена для поддержки диспетчера сертификатов MIM.

### <a name="creating-service-accounts-and-groups"></a>Создание учетных записей служб и групп

В следующей таблице перечислены учетные записи и разрешения, необходимые для диспетчера сертификатов MIM. Вы можете разрешить MIM CM автоматически создать следующие учетные записи или создать их самостоятельно до установки. Имена фактических учетных записей могут быть другими. При создании учетных записей вручную рекомендуется присваивать им такие имена, по которым можно определить их функции.

Пользователи:

![Схема](media/mim-cm-deploy/image010.png)

![Схема](media/mim-cm-deploy/image012.png)

| **Роль**                   | **Имя пользователя для входа** |
|----------------------------|---------------------|
| Агент MIM CM               | MIMCMAgent          |
| Агент восстановления ключей MIM CM  | MIMCMKRAgent        |
| Агент авторизации MIM CM | MIMCMAuthAgent      |
| Агент диспетчера ЦС MIM CM    | MIMCMManagerAgent   |
| Агент веб-пула MIM CM      | MIMCMWebAgent       |
| Агент регистрации MIM CM    | MIMCMEnrollAgent    |
| Служба обновления MIM CM      | MIMCMService        |
| Учетная запись установки MIM        | MIMINSTALL          |
| Агент службы технической поддержки            | CMHelpdesk1-2       |
| Диспетчер CM                 | CMManager1-2        |
| Подписчик            | CMUser1-2           |

Группы:

| **Роль**               | **Группа**         |
|------------------------|-------------------|
| Члены группы службы технической поддержки CM    | MIMCM-Helpdesk    |
| Члены группы диспетчеров CM     | MIMCM-Managers    |
| Члены группы подписчиков CM | MIMCM-Subscribers |

PowerShell: учетные записи агентов

```powershell
import-module activedirectory
## Agent accounts used during setup
$cmagents = @{
"MIMCMKRAgent" = "MIM CM Key Recovery Agent"; 
"MIMCMAuthAgent" = "MIM CM Authorization Agent"
"MIMCMManagerAgent" = "MIM CM CA Manager Agent";
"MIMCMWebAgent" = "MIM CM Web Pool Agent";
"MIMCMEnrollAgent" = "MIM CM Enrollment Agent";
"MIMCMService" = "MIM CM Update Service";
"MIMCMAgent" = "MIM CM Agent";
}
##Groups Used for CM Management
$cmgroups = @{
"MIMCM-Managers" = "MIMCM-Managers"
"MIMCM-Helpdesk" = "MIMCM-Helpdesk"
"MIMCM-Subscribers" = "MIMCM-Subscribers" 
}
##Users Used during testlab
$cmusers = @{
"CMManager1" = "CM Manager1"
"CMManager2" = "CM Manager2"
"CMUser1" = "CM User1"
"CMUser2" = "CM User2"
"CMHelpdesk1" = "CM Helpdesk1"
"CMHelpdesk2" = "CM Helpdesk2"
}

## OU Paths
$aoupath = "OU=Service Accounts,DC=contoso,DC=com" ## Location of Agent accounts
$oupath = "OU=CMLAB,DC=contoso,DC=com" ## Location of Users and Groups for CM Lab


#Create Agents – Update UserprincipalName
$cmagents.GetEnumerator() | Foreach-Object { 
New-ADUser -Name $_.Name -Description $_.Value -UserPrincipalName ($_.Name + "@contoso.com")  -Path $aoupath
$cmpwd = ConvertTo-SecureString "Pass@word1" –asplaintext –force
Set-ADAccountPassword –identity $_.Name –NewPassword $cmpwd
Set-ADUser -Identity $_.Name -Enabled $true
}


#Create Users
$cmusers.GetEnumerator() | Foreach-Object { 
New-ADUser -Name $_.Name -Description $_.Value -Path $oupath
$cmpwd = ConvertTo-SecureString "Pass@word1" –asplaintext –force
Set-ADAccountPassword –identity $_.Name –NewPassword $cmpwd
Set-ADUser -Identity $_.Name -Enabled $true
}
```

### <a name="update-corpcm-server-local-policy-for-agent-accounts"></a>Изменение локальной политики сервера **CORPCM** для учетных записей агентов 

| **Имя пользователя для входа** | **Описание и разрешения**   |
|------|---------------------|
| MIMCMAgent          | Предоставляет следующие службы: </br>— получает зашифрованные закрытые ключи из ЦС; </br>— обеспечивает защиту данных ПИН-кода смарт-карты в базе данных FIM CM; </br>— защищает обмен данными между FIM CM и ЦС. </br></br> Этой учетной записи пользователя требуются следующие параметры управления доступом:</br>право пользователя -   **Разрешение на локальный вход**;</br>право пользователя -   **Выдача сертификатов и управление ими**; </br>— право на чтение и запись в папку Temp системы по следующему пути %WINDIR%\\Temp;</br>— цифровая подпись и сертификат шифрования, выданный и установленный в хранилище пользователя.
|MIMCMKRAgent        | Восстанавливает архивные закрытые ключи из ЦС. Этой учетной записи пользователя требуются следующие параметры управления доступом:</br> право пользователя -   **Разрешение на локальный вход**;</br>— членство в локальной группе **администраторов**; </br>— разрешение на регистрацию для шаблона сертификата **KeyRecoveryAgent**; </br>— сертификат агента восстановления ключей, выданный и установленный в хранилище пользователя (сертификат необходимо добавить в список агентов восстановления ключей в ЦС); </br>— право на чтение и запись в папку Temp системы по следующему пути ```%WINDIR%\\Temp.```.                                                                                                                     |
| MIMCMAuthAgent      | Определяет права пользователей и разрешения для пользователей и групп. Этой учетной записи пользователя требуются следующие параметры управления доступом: </br>— членство в группе доменов "Пред-Windows 2000 доступ"; </br> — право пользователя **Создание аудитов безопасности**.             |
| MIMCMManagerAgent   | Выполняет действия по управлению ЦС. </br> Этому пользователю необходимо назначить разрешение на управление ЦС.        |
| MIMCMWebAgent       | Предоставляет удостоверение для пула приложений IIS. FIM CM выполняется в процессе API Microsoft Win32®, использующем учетные данные этого пользователя. </br> Этой учетной записи пользователя требуются следующие параметры управления доступом:</br> — членство в локальной группе **IIS_WPG, windows 2016 = IIS_IUSRS**; </br>— членство в локальной группе **администраторов**;</br>— право пользователя **Создание аудитов безопасности**; </br>— право пользователя **Работа в режиме операционной системы**; </br>— право пользователя **Замена маркера уровня процесса**;</br>— назначение в качестве удостоверения пула приложений IIS, **CLMAppPool**; </br>— разрешение на чтение данных в разделе реестра **HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\CLM\\v1.0\\Server\\WebUser**; </br>— кроме того, эта учетная запись должна быть доверенной для делегирования.|
| MIMCMEnrollAgent    | Выполняет регистрацию от имени пользователя. Этой учетной записи пользователя требуются следующие параметры управления доступом:</br>— сертификат агента регистрации, выданный и установленный в хранилище пользователя.</br>право пользователя -   **Разрешение на локальный вход**; </br>— разрешение на регистрацию для шаблона сертификата **Агент регистрации** (или пользовательского шаблона, если таковой используется).                 |

### <a name="creating-certificate-templates-for-mim-cm-service-accounts"></a>Создание шаблонов сертификатов для учетных записей служб MIM CM

Трем учетным записям служб, используемым MIM CM, требуются сертификаты; и мастер настройки запрашивает имена шаблонов сертификатов, которые будут использоваться для запроса соответствующих сертификатов.

Учетные записи служб, которым требуются сертификаты

- MIMCMAgent — этой учетной записи требуется сертификат пользователя.

- MIMCMEnrollAgent — этой учетной записи требуется сертификат агента регистрации.

- MIMCMKRAgent — этой учетной записи требуется сертификат **агента восстановления ключей**.

В AD уже имеются соответствующие шаблоны, но нам потребуется создать собственные версии для работы с MIM CM, так как нам необходимо внести изменения в исходные базовые шаблоны.

Всем трем из указанных выше учетных записей будут назначены повышенные права, поэтому они требуют ответственного отношения.

#### <a name="create-the-mim-cm-signing-certificate-template"></a>Создание шаблона сертификата для подписи MIM CM

1. В меню **Администрирование** откройте раздел **Центр сертификации**.

2. В навигационном дереве консоли **центра сертификации** разверните узел **Contoso-CorpCA** и щелкните **Шаблоны сертификатов**.

3. Щелкните правой кнопкой мыши элемент **Шаблоны сертификатов**и затем выберите **Управление**.

4. В **панели результатов** консоли **Шаблоны сертификатов** щелкните правой кнопкой мыши элемент **Пользователь** и выберите пункт **Скопировать шаблон**.

5. В диалоговом окне **Скопировать шаблон** выберите **Windows Server 2003 Enterprise**, а затем нажмите кнопку **ОК**.

    ![Показать последующие изменения](media/mim-cm-deploy/image014.png)

    >[!NOTE]
    >MIM CM не работает с сертификатами на основе шаблонов сертификатов версии 3. Нужно создать шаблон сертификата Windows Server® 2003 Enterprise (версия 2). Дополнительную информацию см. в статье [Сведения о версии 3](https://blogs.msdn.microsoft.com/ms-identity-support/2016/07/14/faq-for-fim-2010-to-support-sha2-kspcng-and-v3-certificate-templates-for-issuing-user-and-agent-certificates-and-mim-2016-upgrade).

6. В диалоговом окне **Свойства нового шаблона** на вкладке **Общие** в поле **Отображаемое имя шаблона** введите **Подпись MIM CM**. Измените **срок действия** на **2 года**, а затем снимите флажок **Опубликовать сертификат в Active Directory**.

7. На вкладке **Обработка запроса** убедитесь, что установлен флажок **Разрешить экспортировать закрытый ключ**, и перейдите на вкладку **Шифрование**.

8. В диалоговом окне **выбора поставщика служб шифрования** отключите **Microsoft Enhanced Cryptographic Provider версии 1.0**, включите **Microsoft Enhanced RSA and AES Cryptographic Provider**, а затем нажмите кнопку **ОК**.

9. На вкладке **Имя субъекта** снимите флажки **Включить имя электронной почты в имя субъекта** и **Имя электронной почты**.

10. На вкладке **Расширения** в разделе **Расширения, включенные в этот шаблон** выберите **Политики применения**, а затем щелкните **Изменить**.

11. В диалоговом окне **Изменение расширения политик применения** выберите политики приложений **Шифрованная файловая система** и **Защищенная электронная почта**. Нажмите кнопку **Удалить**, а затем нажмите кнопку **ОК**.

12. На вкладке **Безопасность** выполните следующие действия.

    - Удалите **администратора**.

    - Удалите **администраторов домена**.

    - Удалите **пользователей домена**.

    - Назначьте **администраторам предприятия** только разрешения на **чтение** и **запись**.

    - Добавьте **MIMCMAgent**.

    - Назначьте разрешения на **чтение** и **регистрацию** учетной записи **MIMCMAgent**.

13. В диалоговом окне **Свойства нового шаблона** нажмите кнопку **ОК**.

14. Не закрывайте **консоль шаблонов сертификатов**.

#### <a name="create-the-mim-cm-enrollment-agent-certificate-template"></a>Создание шаблона сертификата агента регистрации MIM CM

1. В **панели результатов** консоли **Шаблоны сертификатов** щелкните правой кнопкой мыши элемент **Агент регистрации** и выберите пункт **Скопировать шаблон**.

2. В диалоговом окне **Скопировать шаблон** выберите **Windows Server 2003 Enterprise**, а затем нажмите кнопку **ОК**.

3. В диалоговом окне **Свойства нового шаблона** на вкладке **Общие** в поле **Отображаемое имя шаблона** введите **Агент регистрации MIM CM**. Убедитесь, что задан **срок действия** **2 года**.

4. На вкладке **Обработка запроса** установите флажок **Разрешить экспортировать закрытый ключ**, а затем перейдите на вкладку **Поставщики служб шифрования** или "Шифрование".

5. В диалоговом окне **выбора поставщика** отключите **Microsoft Base Cryptographic Provider v1.0**, отключите **Microsoft Enhanced Cryptographic Provider v1.0**, включите **Microsoft Enhanced RSA and AES Cryptographic Provider**, а затем нажмите кнопку **ОК**.

6. На вкладке **Безопасность** выполните следующие действия.

    - Удалите **администратора**.

    - Удалите **администраторов домена**.

    - Назначьте **администраторам предприятия** только разрешения на **чтение** и **запись**.

    - Добавьте **MIMCMEnrollAgent**.

    - Назначьте разрешения на **чтение** и **регистрацию** учетной записи **MIMCMEnrollAgent**.

7. В диалоговом окне **Свойства нового шаблона** нажмите кнопку **ОК**.

8. Не закрывайте **консоль шаблонов сертификатов**.

#### <a name="create-the-mim-cm-key-recovery-agent-certificate-template"></a>Создание шаблона сертификата агента восстановления ключей MIM CM

1. В **панели результатов** консоли **Шаблоны сертификатов** щелкните правой кнопкой мыши элемент **Агент восстановления ключей** и выберите пункт **Скопировать шаблон**.

2. В диалоговом окне **Скопировать шаблон** выберите **Windows Server 2003 Enterprise**, а затем нажмите кнопку **ОК**.

3. В диалоговом окне **Свойства нового шаблона** на вкладке **Общие** в поле **Отображаемое имя шаблона** введите **Агент восстановления ключей MIM CM**. Убедитесь, что на вкладке **Шифрование** задан **срок действия** **2 года**.

4. В диалоговом окне **выбора поставщика** отключите **Microsoft Enhanced Cryptographic Provider версии 1.0**, включите **Microsoft Enhanced RSA and AES Cryptographic Provider**, а затем нажмите кнопку **ОК**.

5. Откройте вкладку **Требования выдачи** и убедитесь, что для параметра **Одобрение диспетчера сертификатов ЦС** задано значение **Отключено**.

6. На вкладке **Безопасность** выполните следующие действия.

    - Удалите **администратора**.

    - Удалите **администраторов домена**.

    - Назначьте **администраторам предприятия** только разрешения на **чтение** и **запись**.

    - Добавьте **MIMCMKRAgent**.

    - Назначьте разрешения на **чтение** и **регистрацию** учетной записи **KRAgent**.

7. В диалоговом окне **Свойства нового шаблона** нажмите кнопку **ОК**.

8. Закройте **Консоль шаблонов сертификатов**.

#### <a name="publish-the-required-certificate-templates-at-the-certification-authority"></a>Публикация необходимых шаблонов сертификатов в центре сертификации

1. Снова откройте консоль **центра сертификации**.

2. В консоли **центра сертификации** щелкните правой кнопкой мыши пункт **Шаблоны сертификатов**, наведите указатель на пункт **Создать**, а затем выберите **Выдаваемый шаблон сертификата**.

3. В диалоговом окне **Включение шаблонов сертификатов** выберите **Агент регистрации MIM CM**, **Агент восстановления ключей MIM CM** и **Подпись MIM CM**. Нажмите кнопку **ОК**.

4. В дереве консоли щелкните **Шаблоны сертификатов**.

5. Убедитесь, что три новых шаблона отображаются в области **сведений**, а затем закройте консоль **центра сертификации**.

    ![Подпись MIM CM](media/mim-cm-deploy/image016.png)

6. Закройте все открытые окна и выйдите из системы.

### <a name="iis-configuration"></a>Настройка служб IIS

Чтобы разместить веб-сайт для CM, установите и настройте службы IIS.

#### <a name="install-and-configure-iis"></a>Установка и настройка служб IIS

1. Войдите в **CORLog in** по учетной записи **MIMINSTALL**.

    >[!IMPORTANT]
    >Учетной записи установки MIM должны быть назначены права локального администратора.

2. Откройте PowerShell и выполните следующую команду.

    `Install-WindowsFeature –ConfigurationFilePath`

>[!NOTE]
>Сайт с именем "Веб-сайт по умолчанию" устанавливается по умолчанию со службами IIS 7. Если этот сайт был переименован или удален, сайт с именем "Веб-сайт по умолчанию" должен быть доступен перед установкой MIM CM.

#### <a name="configuring-kerberos"></a>Настройка Kerberos

Учетная запись MIMCMWebAgent будет выполняться на портале MIM CM. По умолчанию в службах IIS и более поздней версии используется проверка подлинности в режиме ядра. Вам потребуется отключить проверку подлинности Kerberos в режиме ядра и настроить имена субъектов-служб для учетной записи MIMCMWebAgent. Для выполнения некоторых команд требуются повышенные разрешения в Active Directory и на сервере CORPCM.

![Схема](media/mim-cm-deploy/image020.png)

```powershell
#Kerberos settings
#SPN
SETSPN -S http/cm.contoso.com contoso\MIMCMWebAgent
#Delegation for certificate authority
Get-ADUser CONTOSO\MIMCMWebAgent | Set-ADObject -Add @{"msDS-AllowedToDelegateTo"="rpcss/CORPCA","rpcss/CORPCA.contoso.com"}

```

**Обновление служб IIS на сервере CORPCM**

![Схема](media/mim-cm-deploy/image022.png)

```powershell
add-pssnapin WebAdministration

Set-WebConfigurationProperty -Filter System.webServer/security/authentication/WindowsAuthentication -Location 'Default Web Site' -Name enabled -Value $true
Set-WebConfigurationProperty -Filter System.webServer/security/authentication/WindowsAuthentication -Location 'Default Web Site' -Name useKernelMode -Value $false
Set-WebConfigurationProperty -Filter System.webServer/security/authentication/WindowsAuthentication -Location 'Default Web Site' -Name useAppPoolCredentials -Value $true

```

>[!NOTE]
>Вам потребуется добавить DNS-запись A для cm.contoso.com и указать на IP-адрес сервера CORPCM.

#### <a name="requiring-ssl-on-the-mim-cm-portal"></a>Требование шифрования SSL на портале MIM CM

Настоятельно рекомендуется задать требование шифрования SSL на портале MIM CM. В противном случае мастер выдаст соответствующее предупреждение.

1. Зарегистрируйтесь в веб-сертификате для **cm.contoso.com**, назначенном сайту по умолчанию.

2. Откройте **диспетчер служб IIS** и перейдите к разделу **Управление сертификатами**.

3. В окне "Просмотр возможностей" дважды щелкните пункт "Параметры SSL".

4. На странице параметров SSL выберите пункт **Требовать SSL**.

5. На панели действий нажмите кнопку **Применить**.

### <a name="database-configuration-corpsql-for-mim-cm"></a>Настройка базы данных **CORPSQL** для MIM CM

1. Убедитесь, что вы подключены к серверу CORPSQL01.

2. Выполните вход как администратор базы данных SQL.

3. Выполните следующий сценарий T-SQL, чтобы предоставить учетной записи CONTOSO\\MIMINSTALL права на создание базы данных (которая потребуется на этапе настройки).

    >[!NOTE]
    >Нам потребуется вернуться к SQL, когда все будет готово для настройки модулей политики и выхода.

    ```sql
    create login [CONTOSO\\MIMINSTALL] from windows;
    exec sp_addsrvrolemember 'CONTOSO\\MIMINSTALL', 'dbcreator';
    exec sp_addsrvrolemember 'CONTOSO\\MIMINSTALL', 'securityadmin';  
    ```

![Сообщение об ошибке мастера настройки MIM CM](media/mim-cm-deploy/image024.png)

## <a name="deployment-of-microsoft-identity-manager-2016-certificate-management"></a>Развертывание компонента управления сертификатами Microsoft Identity Manager 2016

1. Убедитесь, что вы подключены к серверу CORPCM и что учетная запись **MIMINSTALL** является членом группы **локальных администраторов**.

2. Выполните вход с учетной записью Contoso\\MIMINSTALL.

3. Подключите ISO-образ Microsoft Identity Manager с пакетом обновления 1 (SP1).

4. **Откройте** каталог **Certificate Management\\x64**.

5. В папке **x64** щелкните файл **Setup** правой кнопкой мыши и выберите пункт **Запуск от имени администратора**.

6. На странице приветствия мастера установки компонента управления сертификатами Microsoft Identity Manager нажмите кнопку **Далее**.

7. На странице "Лицензионное соглашение" прочитайте условия соглашения, установите **флажок** "Я принимаю условия лицензионного соглашения" и нажмите кнопку "Далее".

8. На странице "Выборочная установка" убедитесь, что установлены флажки для компонентов **Портал MIM CM** и **Служба обновлений MIM CM**, а затем нажмите кнопку **Далее**.

9. На странице "Виртуальная веб-папка" убедитесь, что имя виртуальной папки — **CertificateManagement**, а затем нажмите кнопку **Далее**.

10. На странице установки компонента управления сертификатами Microsoft Identity Manager нажмите кнопку **Установить**.

11. На странице **завершения** мастера установки компонента управления сертификатами Microsoft Identity Manager нажмите кнопку **Готово**.

![Мастер MIM CM завершил работу.](media/mim-cm-deploy/image026.png)

### <a name="configuration-wizard-of-microsoft-identity-manager-2016-certificate-management"></a>Мастер настройки компонента управления сертификатами Microsoft Identity Manager 2016

Прежде чем войти в систему CORPCM, добавьте учетную запись MIMINSTALL в группу  **администраторов домена, администраторов схемы и локальных администраторов** для мастера настройки. Ее можно удалить из этих групп после завершения настройки.

![Сообщение об ошибке](media/mim-cm-deploy/image028.png)

1. В меню **Пуск** щелкните **мастер настройки компонента управления сертификатами**. Щелкните **Запуск от имени администратора**.

2. На странице **приветствия мастера настройки** нажмите кнопку **Далее**.

3. На странице **настройки ЦС** убедитесь, что выбран центр сертификации **Contoso-CORPCA-CA**, сервер **CORPCA.CONTOSO.COM**, а затем нажмите кнопку **Далее**.

4. На странице **Настройка базы данных Microsoft® SQL Server®** в поле **Имя SQL Server** введите **CORPSQL1**, установите флажок **Использовать мои учетные данные для создания базы данных** и нажмите кнопку **Далее**.

5. На странице **Параметры базы данных** примите имя базы данных по умолчанию **FIMCertificateManagement**, убедитесь, что установлен флажок **Встроенная проверка подлинности SQL**, а затем нажмите кнопку **Далее**.

6. На странице **Настройка Active Directory** примите имя по умолчанию для точки подключения службы и нажмите кнопку **Далее**.

7. На странице **Метод проверки подлинности** убедитесь, что выбран вариант **Встроенная проверка подлинности Windows**, а затем нажмите кнопку **Далее**.

8. На странице **Агенты — FIM CM** снимите флажок **Использовать параметры FIM CM по умолчанию** и щелкните **Пользовательские учетные записи**.

9. В диалоговом окне с несколькими вкладками **Агенты — FIM CM** на каждой вкладке введите следующие сведения.

   - Имя пользователя: **Update**

   - Пароль: **Pass\@word1**

   - Подтверждение пароля: **Pass\@word1**

   - Использовать существующую роль пользователя: **включено**

    >[!NOTE]
    >Это учетные записи, которые мы создали ранее. Процедуру, описанную в шаге 8, необходимо повторить для вкладок всех шести учетных записей агентов.

    ![Учетные записи MIM CM](media/mim-cm-deploy/image030.png)

10. После заполнения всех сведений об учетной записи агента нажмите кнопку **ОК**.

11. На странице **Агенты — MIM CM** нажмите кнопку **Далее**.

12. На странице **Настройка сертификатов сервера** включите следующие шаблоны сертификатов:

    - шаблон сертификата, используемый для сертификата агента восстановления ключей, **MIMCMKeyRecoveryAgent**;

    - шаблон сертификата, используемый для сертификата агента FIM CM, **MIMCMSigning**;

    - шаблон сертификата, используемый для сертификата агента регистрации, **FIMCMEnrollmentAgent**.

13. На странице **Настройка сертификатов сервера** нажмите кнопку **Далее**.

14. На странице **настройки сервера электронной почты и печати документа** введите имя в поле **Укажите имя SMTP-сервера, который будет использоваться для регистрации уведомлений по электронной почте** и нажмите кнопку **Далее**.

15. На странице **Готово к настройке** нажмите кнопку **Настройка**.

16. В диалоговом окне предупреждения **мастера настройки — Microsoft Forefront Identity Manager 2010 R2** нажмите кнопку **ОК** для подтверждения того, что шифрование SSL не включено для виртуального каталога IIS.

    ![media/image17.png](media/mim-cm-deploy/image032.png)

    >[!NOTE] 
    >Не нажимайте кнопку "Готово", пока мастер настройки не завершит работу. Журналы мастера можно найти здесь: **%programfiles%\\Microsoft Forefront Identity Management\\2010\\Certificate Management\\config.log**.

17. Нажмите кнопку **Готово**.

    ![Мастер MIM CM завершил работу.](media/mim-cm-deploy/image033.png)

18. Закройте все открытые окна.

19. Добавьте https://cm.contoso.com/certificatemanagement в зону местной интрасети в браузере.

20. Откройте сайт через сервер CORPCM https://cm.contoso.com/certificatemanagement.  

    ![Схема](media/mim-cm-deploy/image035.png)

### <a name="verify-the-cng-key-isolation-service"></a>Проверка службы изоляции ключей CNG

1. В меню **Администрирование** щелкните **Службы**.

2. В области **сведений** дважды щелкните элемент **Изоляция ключей CNG**.

3. На вкладке **Общие** измените **тип запуска** на **Автоматически**.

4. На вкладке **Общие** запустите службу, если она не находится в запущенном состоянии.

5. На вкладке **Общие** нажмите кнопку **ОК**.

### <a name="installing-and-configuring-the-ca-modules-"></a>Установка и настройка модулей ЦС

На этом этапе мы установим и настроим модули ЦС FIM CM для центра сертификации.

1. Настройка проверки только разрешений пользователя для операций управления в FIM CM

2. В папке **C:\\Program Files\\Microsoft Forefront Identity Manager\\2010\\Certificate Management\\web** создайте копию файла **web.config**, назвав ее **web.1.config**.

3. В папке **Web** щелкните правой кнопкой мыши файл **Web.config** и выберите пункт **Открыть**.

    >[!Note]
    >Файл Web.config открывается в Блокноте.

4. В открытом файле нажмите клавиши CTRL+F.

5. В диалоговом окне **Поиск и замена** в поле **Найти** введите **UseUser**, а затем нажмите кнопку **Найти далее** три раза.

6. Закройте диалоговое окно **Поиск и замена**.

7. Курсор должен оказаться в строке **\<add key="Clm.RequestSecurity.Flags" value="UseUser,UseGroups" /\>**. Измените строку следующим образом: **\<add key="Clm.RequestSecurity.Flags" value="UseUser" /\>**.

8. Закройте файл, сохранив все изменения.

9. Создайте учетную запись для компьютера ЦС на сервере SQL \<нет сценария\>.

10. Убедитесь, что вы подключены к серверу **CORPSQL01**.

11. Выполните вход как **администратор базы данных**.

12. В меню **Пуск** запустите **SQL Server Management Studio**.

13. В диалоговом окне **Подключение к серверу** в списке **Имя сервера** введите **CORPSQL01**, а затем щелкните **Подключить**.

14. В дереве консоли разверните узел **Безопасность**, а затем щелкните **Имена входа**.

15. Щелкните правой кнопкой мыши элемент **Имена входа**и выберите **Создать имя входа**.

16. На странице **Общие** в поле **Имя для входа** введите **contoso\\CORPCA\$**. Выберите параметр **Проверка подлинности Windows**. База данных по умолчанию — **FIMCertificateManagement**.

17. В левой области щелкните **Сопоставление пользователей**. В области справа установите флажок в столбце **Сопоставить** рядом с параметром **FIMCertificateManagement**. В списке **членство в роли базы данных для: FIMCertificateManagement** включите роль **clmApp**.

18. Нажмите кнопку **ОК**.

19. Выйдите из программы **Microsoft SQL Server Management Studio**.

### <a name="install-the-fim-cm-ca-modules-on-the-certification-authority"></a>Установка ЦС модулей FIM CM для центра сертификации

1. Убедитесь, что вы подключены к серверу **CORPCA**.

2. В папке **X64** щелкните файл **Setup.exe** правой кнопкой мыши и выберите пункт **Запуск от имени администратора**.

3. На странице **приветствия мастера установки компонента управления сертификатами Microsoft Identity Manager** нажмите кнопку **Далее**.

4. Ознакомьтесь с условиями соглашения на странице **Лицензионное соглашение**. Установите флажок **Я принимаю условия лицензионного соглашения** и нажмите кнопку **Далее**.

5. На странице **Выборочная установка** выберите **Портал MIM CM**, а затем установите флажок **Этот компонент будет недоступен**.

6. На странице **Выборочная установка** выберите **Служба обновлений MIM CM**, а затем установите флажок **Этот компонент будет недоступен**.

    >[!Note]
    >Таким образом, единственным компонентом, выбранным для установки, будут "Файлы ЦС MIM CM".

7. На странице **Выборочная установка** нажмите кнопку **Далее**.

8. На странице **установки компонента управления сертификатами Microsoft Identity Manager** нажмите кнопку **Установить**.

9. На странице **завершения мастера установки компонента управления сертификатами Microsoft Identity Manager** нажмите кнопку **Готово**.

10. Закройте все открытые окна.

### <a name="configure-the-mim-cm-exit-module"></a>Настройка модуля выхода MIM CM

1. В меню **Администрирование** откройте раздел **Центр сертификации**.

2. В дереве консоли щелкните правой кнопкой мыши **contoso-CORPCA-CA** и выберите пункт **Свойства**.

3. На вкладке **Модуль выхода** выберите **Модуль выхода FIM CM**, а затем нажмите кнопку **Свойства**.

4. В поле **Укажите строку подключения базы данных CM** введите **Connect Timeout=15;Persist Security Info=True; Integrated Security=sspi;Initial Catalog=FIMCertificateManagement;Data Source=CORPSQL01**. Оставьте установленным флажок в поле **Шифровать строку подключения**, а затем нажмите кнопку **ОК**.
5. В окне сообщения **Управление сертификатами Microsoft FIM** нажмите кнопку **ОК**.

6. В диалоговом окне **Свойства contoso-CORPCA-CA** нажмите кнопку **ОК**.

7. Щелкните правой кнопкой мыши **contoso-CORPCA-CA****, наведите указатель на пункт **Все задачи** и щелкните **Остановить службу**. Дождитесь остановки служб сертификатов Active Directory.

8. Щелкните правой кнопкой мыши **contoso-CORPCA-CA****, наведите указатель на пункт **Все задачи** и щелкните **Запустить службу**.

9. Сверните консоль **центра сертификации**.

10. В меню **Администрирование** щелкните **Просмотр событий**.

11. В дереве консоли разверните узел **Журналы приложений и служб**, а затем щелкните **Управление сертификатами FIM**.

12. В списке событий убедитесь, что последние события *не* включают события **Предупреждение** или **Ошибка** с момента последнего перезапуска служб сертификатов.

    >[!NOTE] 
    >Последнее событие должно сообщать о загрузке модулем выхода с помощью параметров из `SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\ContosoRootCA\ExitModules\Clm.Exit`.

13. Сверните окно **просмотра событий**.

### <a name="copy-the-mimcmagent-certificates-thumbprint-to-windows-clipboard"></a>Скопируйте отпечаток сертификата MIMCMAgent в буфер обмена Windows®.

1. Снова откройте консоль **центра сертификации**.

2. В дереве консоли разверните узел **contoso-CORPCA-CA**, а затем щелкните **Выданные сертификаты**.

3. В области **сведений** дважды щелкните сертификат, в столбце **Имя запросившего** которого указано **CONTOSO\\MIMCMAgent**, а в столбце **Шаблон сертификата** — **Подпись FIM CM**.

4. На вкладке **Сведения** выделите поле **Отпечаток** .

5. Выберите отпечаток и нажмите клавиши CTRL+C.

    >[!NOTE]
    >**Не** включайте начальный пробел в списке символов отпечатка.

6. В диалоговом окне **Сертификат** нажмите кнопку **ОК**.

7. В меню **Пуск** в поле **Найти программы и файлы** введите **Блокнот**, а затем нажмите клавишу ВВОД.

8. В **Блокноте** в меню **Правка**щелкните **Вставить**.

9. В меню **Правка** выберите команду **Изменить**.

10. В поле **Найти** введите символ пробела и нажмите кнопку **Заменить все**.

    >[!Note]
    >При этом будут удалены все пробелы между символами в отпечатке.

11. В диалоговом окне **Заменить** нажмите кнопку **Отмена**.

12. Выберите преобразованную *строку отпечатка* и нажмите клавиши CTRL+C.

13. Закройте **Блокнот**, не сохраняя изменения.

### <a name="configure-the-fim-cm-policy-module"></a>Настройка модуля политики FIM CM

1. Снова откройте консоль **центра сертификации**.

2. Щелкните правой кнопкой мыши **contoso-CORPCA-CA** и выберите пункт **Свойства**.

3. В диалоговом окне **Свойства contoso-CORPCA-CA** на вкладке **Модуль политики** щелкните **Свойства**.

    - На вкладке **Общие** убедитесь, что установлен флажок **Передавать запросы, не относящиеся к FIM CM, в модуль политики по умолчанию для обработки запросов**.

    - На вкладке **Сертификаты подписи** щелкните **Добавить**.

    - В диалоговом окне "Сертификат" щелкните правой кнопкой мыши поле **Укажите значение хэша сертификата в шестнадцатеричной кодировке** и выберите пункт **Вставить**.

    - В диалоговом окне **Сертификат** нажмите кнопку **ОК**.
    
        >[!Note]
        >Если кнопка **ОК** недоступна, значит вы случайно включили скрытый символ в строку отпечатка при копировании отпечатка из сертификата clmAgent. Повторите все шаги, начиная с пункта **Шаг 4. Скопируйте отпечаток сертификата MIMCMAgent в буфер обмена Windows** в этом руководстве.

4. В диалоговом окне **Свойства конфигурации** убедитесь, что отпечаток отображается в списке **Действительные сертификаты подписи**, а затем нажмите кнопку **OK**.

5. В окне сообщения **Управление сертификатами FIM** нажмите кнопку **ОК**.

6. В диалоговом окне **Свойства contoso-CORPCA-CA** нажмите кнопку **ОК**.

7. Щелкните правой кнопкой мыши **contoso-CORPCA-CA****, наведите указатель на пункт **Все задачи** и щелкните **Остановить службу**.

8. Дождитесь остановки служб сертификатов Active Directory.

9. Щелкните правой кнопкой мыши **contoso-CORPCA-CA****, наведите указатель на пункт **Все задачи** и щелкните **Запустить службу**.

10. Закройте консоль **центра сертификации**.

11. Закройте все открытые окна и выйдите из системы.

**Последний шаг в развертывании**: нам необходимо убедиться, что учетная запись CONTOSO\\MIMCM-Managers может развертывать и создавать шаблоны и настраивать систему, не являясь администратором схемы и домена. Следующий сценарий создаст список управления доступом с разрешениями для шаблонов сертификатов с помощью dsacls. Выполните команду с учетной записью, имеющей полный набор прав на изменение разрешений безопасности "Чтение" и "Запись" для каждого существующего шаблона сертификата в лесу.

Первые шаги: **настройка точки подключения службы и разрешений целевой группы, а также делегирование управления шаблоном профиля**

1. Настройте разрешения для точки подключения службы (SCP).

2. Настройте делегированное управление шаблоном профиля.

3. Настройте разрешения для точки подключения службы (SCP). **\<нет сценария\>**

4.   Убедитесь, что вы подключены к виртуальному серверу **CORPDC**.

5. Войдите в систему как **contoso\\corpadmin**.

6. В разделе **Администрирование** откройте оснастку **Пользователи и компьютеры Active Directory**.

7. На странице **Пользователи и компьютеры Active Directory** в меню **Вид** убедитесь, что выбран пункт **Дополнительные параметры**.

8. В дереве консоли разверните узел **Contoso.com** \| **Система** \| **Microsoft** \| **Диспетчер жизненного цикла сертификата**, а затем щелкните **CORPCM**.

9. Щелкните правой кнопкой мыши **CORPCM** и выберите пункт **Свойства**.

10. В диалоговом окне **Свойства CORPCM** на вкладке **Безопасность** добавьте следующие группы с соответствующими разрешениями.

    | Group          | Разрешения      |
    |----------------|------------------|
    | mimcm-Managers | Чтение </br> Аудит FIM CM</br> Агент регистрации FIM CM</br> Регистрация запроса FIM CM</br> Восстановление запроса FIM CM</br> Продление запроса FIM CM</br> Отзыв запроса FIM CM </br> Запрос на снятие блокировки смарт-карты FIM CM |
    | mimcm-HelpDesk | Чтение</br> Агент регистрации FIM CM</br> Отзыв запроса FIM CM</br> Запрос на снятие блокировки смарт-карты FIM CM |

11. В диалоговом окне **Свойства CORPDC** нажмите кнопку **ОК**.

12. Не закрывайте окно **Пользователи и компьютеры Active Directory**.

**Настройка разрешений для дочерних объектов пользователя**

1. Убедитесь, что вы по-прежнему находитесь в консоли **Пользователи и компьютеры Active Directory**.

2. В дереве консоли щелкните **Contoso.com** правой кнопкой мыши и выберите пункт **Свойства**.

3. На вкладке **Безопасность** нажмите кнопку **Дополнительно**.

4. В диалоговом окне **Дополнительные параметры безопасности для Contoso** нажмите кнопку **Добавить**.

5. В диалоговом окне **Выбор пользователя, компьютера, учетной записи службы или группы** в текстовом поле **Введите имя объекта** введите **mimcm-Managers**, а затем нажмите кнопку **ОК**.

6. В диалоговом окне **Запись разрешения для Contoso** в списке **Применить к** выберите **Дочерние объекты пользователя**, а затем установите флажок **Разрешить** для следующих **разрешений**.

    - **Чтение всех свойств**
    
    - **Разрешения на чтение**

    - **Аудит FIM CM**

    - **Агент регистрации FIM CM**

    - **Регистрация запроса FIM CM**

    - **Восстановление запроса FIM CM**

    - **Продление запроса FIM CM**

    - **Отзыв запроса FIM CM**

    - **Запрос на снятие блокировки смарт-карты FIM CM**

7. В диалоговом окне **Запись разрешения для Contoso** нажмите кнопку **ОК**.

8. В диалоговом окне **Дополнительные параметры безопасности для Contoso** нажмите кнопку **Добавить**.

9. В диалоговом окне **Выбор пользователя, компьютера, учетной записи службы или группы** в текстовом поле **Введите имя объекта** введите **mimcm-HelpDesk**, а затем нажмите кнопку **ОК**.

10. В диалоговом окне **Запись разрешения для Contoso** в списке **Применить к** выберите **Дочерние объекты пользователя**, а затем установите флажок **Разрешить** для следующих **разрешений**.

    - **Чтение всех свойств**

    - **Разрешения на чтение**

    - **Агент регистрации FIM CM**

    - **Отзыв запроса FIM CM**

    - **Запрос на снятие блокировки смарт-карты FIM CM**

11. В диалоговом окне **Запись разрешения для Contoso** нажмите кнопку **ОК**.

12. В диалоговом окне **Дополнительные параметры безопасности для Contoso** нажмите кнопку **ОК**.

13. В диалоговом окне **Свойства contoso.com** нажмите кнопку **ОК**.

14. Не закрывайте окно **Пользователи и компьютеры Active Directory**.

**Настройка разрешений для дочерних объектов пользователя \<нет сценария\>**

1. Убедитесь, что вы по-прежнему находитесь в консоли **Пользователи и компьютеры Active Directory**.

2. В дереве консоли щелкните **Contoso.com** правой кнопкой мыши и выберите пункт **Свойства**.

3. На вкладке **Безопасность** нажмите кнопку **Дополнительно**.

4. В диалоговом окне **Дополнительные параметры безопасности для Contoso** нажмите кнопку **Добавить**.

5. В диалоговом окне **Выбор пользователя, компьютера, учетной записи службы или группы** в текстовом поле **Введите имя объекта** введите **mimcm-Managers**, а затем нажмите кнопку **ОК**.

6. В диалоговом окне **Запись разрешения для CONTOSO** в списке **Применить к** выберите **Дочерние объекты пользователя**, а затем установите флажок **Разрешить** для следующих **разрешений**.

    - **Чтение всех свойств**

    - **Разрешения на чтение**

    - **Аудит FIM CM**

    - **Агент регистрации FIM CM**

    - **Регистрация запроса FIM CM**

    - **Восстановление запроса FIM CM**

    - **Продление запроса FIM CM**

    - **Отзыв запроса FIM CM**

    - **Запрос на снятие блокировки смарт-карты FIM CM**

7. В диалоговом окне **Запись разрешения для CONTOSO** нажмите кнопку **ОК**.

8. В диалоговом окне **Дополнительные параметры безопасности для CONTOSO** нажмите кнопку **Добавить**.

9. В диалоговом окне **Выбор пользователя, компьютера, учетной записи службы или группы** в текстовом поле **Введите имя объекта** введите **mimcm-HelpDesk**, а затем нажмите кнопку **ОК**.

10. В диалоговом окне **Запись разрешения для CONTOSO** в списке **Применить к** выберите **Дочерние объекты пользователя**, а затем установите флажок **Разрешить** для следующих **разрешений**.

    - **Чтение всех свойств**

    - **Разрешения на чтение**

    - **Агент регистрации FIM CM**

    - **Отзыв запроса FIM CM**

    - **Запрос на снятие блокировки смарт-карты FIM CM**

11. В диалоговом окне **Запись разрешения для contoso** нажмите кнопку **ОК**.

12. В диалоговом окне **Дополнительные параметры безопасности для Contoso** нажмите кнопку **ОК**.

13. В диалоговом окне **Свойства contoso.com** нажмите кнопку **ОК**.

14. Не закрывайте окно **Пользователи и компьютеры Active Directory**.

Следующие шаги: **делегирование разрешений на управление шаблонами сертификатов\<сценарий\>**

- Делегирование разрешений для контейнера шаблонов сертификатов.

- Делегирование разрешений для контейнера OID.

- Делегирование разрешений для существующих шаблонов сертификатов.

Определение разрешений для контейнера шаблонов сертификатов

1. Снова откройте консоль **Active Directory — сайты и службы**.

2. В дереве консоли разверните узел **Службы**, затем **Службы открытого ключа** и выберите элемент **Шаблоны сертификатов**.

3. В дереве консоли щелкните правой кнопкой мыши **Шаблоны сертификатов** и выберите пункт **Делегировать управление**.

4. В мастере **делегирования управления** нажмите кнопку **Далее**.

5. На странице **Пользователи или группы** щелкните **Добавить**.

6. В поле **Введите имена выбираемых объектов** диалогового окна **Выбор пользователей, компьютеров и групп** введите **mimcm-Managers**, а затем нажмите кнопку **OK**.

7. На странице **Пользователи или группы** щелкните **Далее**.

8. На странице **Делегируемые задачи** щелкните **Создать особую задачу для делегирования**, затем нажмите кнопку **Далее**.

9.  На странице **Тип объекта Active Directory** убедитесь, что выбран вариант **Эта папка, существующие в ней объекты и создание новых объектов в этой папке**, и нажмите кнопку **Далее**.

10. На странице **Разрешения** в списке **разрешений** установите флажок **Полный доступ** и нажмите кнопку **Далее**.

11. На странице **Завершение мастера делегирования управления** нажмите кнопку **Готово**.

Задание разрешений в контейнере OID

1. В дереве консоли щелкните правой кнопкой мыши элемент **OID** и выберите пункт **Свойства**.

2. В диалоговом окне **Свойства OID** на вкладке **Безопасность** щелкните **Дополнительно**.

3. В диалоговом окне **Дополнительные параметры безопасности для OID** нажмите кнопку **Добавить**.

4. В диалоговом окне **Выбор пользователя, компьютера, учетной записи службы или группы** в текстовом поле **Введите имя объекта** введите **mimcm-Managers**, а затем нажмите кнопку **ОК**.

5. В диалоговом окне **Запись разрешений для OID** убедитесь, что разрешения применяются к **этому объекту и всем дочерним объектам**, щелкните **Полный доступ**, а затем нажмите кнопку **ОК**.

6. В диалоговом окне **Дополнительные параметры безопасности для OID** нажмите кнопку **ОК**.

7. В диалоговом окне **Свойства OID** нажмите кнопку **ОК**.

8. Закройте оснастку **Active Directory — сайты и службы**.

**Сценарии: разрешения для контейнера OID, шаблона профиля и шаблонов сертификатов**

![Схема](media/mim-cm-deploy/image021.png)

```powershell
import-module activedirectory
$adace = @{
"OID" = "AD:\\CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=contoso,DC=com";
"CT" = "AD:\\CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=contoso,DC=com";
"PT" = "AD:\\CN=Profile Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=contoso,DC=com"
}
$adace.GetEnumerator() | **Foreach-Object** {
$acl = **Get-Acl** *-Path* $_.Value
$sid=(**Get-ADGroup** "MIMCM-Managers").SID
$p = **New-Object** System.Security.Principal.SecurityIdentifier($sid)
##https://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectorysecurityinheritance(v=vs.110).aspx
$ace = **New-Object** System.DirectoryServices.ActiveDirectoryAccessRule
($p,[System.DirectoryServices.ActiveDirectoryRights]"GenericAll",[System.Security.AccessControl.AccessControlType]::Allow,
[DirectoryServices.ActiveDirectorySecurityInheritance]::All)
$acl.AddAccessRule($ace)
**Set-Acl** *-Path* $_.Value *-AclObject* $acl
}
```

**Сценарии: делегирование разрешений для существующих шаблонов сертификатов.**  

![Схема](media/mim-cm-deploy/image039.png)

```shell
dsacls "CN=Administrator,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=CA,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=CAExchange,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=CEPEncryption,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=ClientAuth,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=CodeSigning,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=CrossCA,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=CTLSigning,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=DirectoryEmailReplication,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=DomainController,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=DomainControllerAuthentication,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=EFS,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=EFSRecovery,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=EnrollmentAgent,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=EnrollmentAgentOffline,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=ExchangeUser,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=ExchangeUserSignature,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=FIMCMSigning,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=FIMCMEnrollmentAgent,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=FIMCMKeyRecoveryAgent,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=IPSecIntermediateOffline,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=IPSecIntermediateOnline,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=KerberosAuthentication,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=KeyRecoveryAgent,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=Machine,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=MachineEnrollmentAgent,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=OCSPResponseSigning,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=OfflineRouter,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=RASAndIASServer,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=SmartCardLogon,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=SmartCardUser,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=SubCA,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=User,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=UserSignature,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=WebServer,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO

dsacls "CN=Workstation,CN=Certificate Templates,CN=Public Key
Services,CN=Services,CN=Configuration,DC=Contoso,DC=com" /G
Contoso\\MIMCM-Managers:SDDTRCWDWOLCWPRPCCDCWSLO
```
