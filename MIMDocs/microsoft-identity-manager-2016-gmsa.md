---
title: Преобразование служб MIM в групповую управляемую учетную запись службы | Документация Майкрософт
description: В этой статье описано, как настроить групповую управляемую учетную запись службы.
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 06/27/2018
ms.topic: article
ms.prod: microsoft-identity-manager
ms.openlocfilehash: d3c0b6677c42d4f14d4f6255a2a661d3ef23661d
ms.sourcegitcommit: 7de35aaca3a21192e4696fdfd57d4dac2a7b9f90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2018
ms.locfileid: "49358301"
---
# <a name="conversion-of-mim-specific-services-to-gmsa"></a>Преобразование служб MIM в групповую управляемую учетную запись службы

В этом руководстве описано, как настроить групповую управляемую учетную запись службы для поддерживаемых служб. Когда среда уже настроена, преобразование в групповую управляемую учетную запись службы выполняется очень просто.

Требуемое исправление: \<ссылка на статью базы знаний\>.

Поддерживается:

-   служба синхронизации MIM (FIMSynchronizationService);
-   служба MIM (FIMService);
-   регистрация пароля MIM;
-   сброс пароля MIM;
-   служба мониторинга PAM (PamMonitoringService);
-   служба компонентов PAM (PrivilegeManagementComponentService).

Не поддерживаются:

-   портал MIM, который считается частью среды SharePoint. Его необходимо развернуть в режиме кластера и настроить для него [автоматическую смену паролей в SharePointServer](https://docs.microsoft.com/sharepoint/administration/configure-automatic-password-change);
-   любые агенты управления;
-   управление сертификатами Microsoft;
-   BHOLD

<a name="general-information"></a>Общие сведения 
--------------------

Что нужно прочитать, чтобы завершить работу с этим руководством

-   [Общие сведения о групповых управляемых учетных записях служб](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview)

-   <https://docs.microsoft.com/powershell/module/addsadministration/new-adserviceaccount?view=win10-ps>

-   <https://technet.microsoft.com/library/jj128430(v=ws.11).aspx>

Первый шаг на контроллере домена Windows

1.  При необходимости создайте корневой ключ KDS службы распространения ключей (один раз для каждого домена). Корневой ключ (в сочетании с дополнительной информацией) используется службой KDS на контроллерах домена для создания паролей.

    -   Add-KDSRootKey –EffectiveImmediately

    -   – EffectiveImmediately указывает на задержку не более \~10 часов и необходимость репликации на все контроллеры домена. Она занимает около 1 часа для двух контроллеров домена.

![](media/7fbdf01a847ea0e330feeaf062e30668.png)

## <a name="synchronization-service"></a>Служба синхронизации
-----------------------

1.  Создайте группу с именем MIMSync_Servers и добавьте в нее все серверы синхронизации.

![](media/a4dc3f6c0cb1f715ba690744f54dce5c.png)

2.  После этого выполните в окне Windows PowerShell от имени администратора домена указанную ниже команду для учетной записи компьютера, уже присоединенного к домену.

    -   New-ADServiceAccount -Name MIMSyncGMSAsvc -DNSHostName MIMSyncGMSAsvc.contoso.com -PrincipalsAllowedToRetrieveManagedPassword "MIMSync_Servers"

![](media/f6deb0664553e01bcc6b746314a11388.png)

-   Получение сведений о GSMA для синхронизации:

![](media/c80b0a7ed11588b3fb93e6977b384be4.png)

-   Если служба PCNS запущена, необходимо обновить делегирование.

    -   Set-ADServiceAccount -Identity MIMSyncGMSAsvc -ServicePrincipalNames \@{Add="PCNSCLNT/mimsync.contoso.com"}

3. После этого в службах синхронизации создайте резервную копию ключа шифрования, которая потребуется при установке с изменением режима.

    -   На сервере, где установлена служба синхронизации, найдите средство управления ключами службы синхронизации.

    -   По умолчанию здесь уже выбран параметр **Экспорт набора ключей**.

    -   Щелкните **Далее**.

    -   Вам будет предложено ввести данные существующей учетной записи синхронизации.

    -   Введите и проверьте данные для учетной записи синхронизации FIM.

        -   "Имя учетной записи" — имя учетной записи службы синхронизации, которая использовалась во время первоначальной установки.

        -   "Пароль" — пароль для учетной записи службы синхронизации.

        -   "Домен" — имя домена, в который входит учетная запись службы синхронизации.

    -   Щелкните **Далее**.

    -   Если вы что-то ввели неправильно, вы получите следующую ошибку:

    -   Итак, вы правильно ввели все сведения об учетной записи. Теперь вы можете изменить место назначения (расположение файла экспорта) для резервной копии ключа шифрования.

        -   По умолчанию для файла экспорта назначается расположение **C:\\Windows\\system32**\\miiskeys-1.bin.

4. Установка службы синхронизации Microsoft Identity Manager SP1 сборки 4.4.1302.0. Вы найдете ее в центре скачивания корпоративных лицензий или на сайте загрузки MSDN. После завершения установки убедитесь, что вы сохранили набор ключей miiskeys.bin.

![](media/ef5f16085ec1b2b1637fa3d577a95dbf.png)


5. Установите версию [пакета исправлений 4.5.x.x](https://docs.microsoft.com/microsoft-identity-manager/reference/version-history) или более позднюю.

- После применения обновлений остановите службу синхронизации FIM.
- Программы панели управления и компоненты Microsoft Identity Manager
- Служба синхронизации "Изменить" -\> "Далее" -\> "Настройка" -\> "Далее"

![](media/dc98c011bec13a33b229a0e792b78404.png)

-  Удалите имя учетной записи
-  Введите новое имя учетной записи **MIMSyncGMSA** с символом \$, как показано
- на снимке экрана. Поле пароля оставьте пустым.

![](media/38df9369bf13e1c3066a49ed20e09041.png)

- "Далее" -\> "Далее" -\> "Установка"
- Восстановите ключи из сохраненного ранее BIN-файла.

![](media/44cd474323584feb6d8b48b80cfceb9b.png)

![](media/03e7762f34750365e963f0b90e43717c.png)
> [!NOTE]
> Добавление разрешений SQL выполняется для создания учетной записи для входа, а значит у пользователя, который применяет изменения, должны быть права на добавление учетной записи и dbo в базе данных службы синхронизации.

## <a name="mim-service"></a>Служба MIM
-----------

>[!IMPORTANT]
>Следующий процесс должен использоваться при первом преобразовании учетных записей, относящихся к службе MIM, в групповые управляемые учетные записи службы. Командлеты PowerShell, которые указаны в приложении, можно использовать только для изменения сведений об учетной записи после завершения первоначальной настройки*.

1.  Создайте групповые управляемые учетные записи для службы MIM, API PAM Rest, службы мониторинга PAM, службы компонентов PAM, портала регистрации SSPR и портала сброса SSPR.

    -   Не забудьте обновить делегирование групповой управляемой учетной записи и имя участника-службы.
        -   Set-ADServiceAccount -Identity \<account\> -ServicePrincipalNames \@{Add="\<SPN\>"}
        -   Делегирование
            -   Set-ADServiceAccount -Identity \<gsmaaccount\> -TrustedForDelegation \$true
        -   Ограниченное делегирование
            -   \$delspns = 'http/mim', 'http/mim.contoso.com'
            -   New-ADServiceAccount -Name \<gsmaaccount\> -DNSHostName \<gsmaaccount\>.contoso.com -PrincipalsAllowedToRetrieveManagedPassword \<group\> -ServicePrincipalNames \$spns -OtherAttributes \@{'msDS-AllowedToDelegateTo'=\$delspns }

2.  Добавьте учетную запись для службы MIM в группы синхронизации. Это требуется для SSPR.

![](media/0201f0281325c80eb70f91cbf0ac4d5b.jpg)

3.  **Примечание.**  Существует известная проблема, приводящая к зависанию службы, которая использует управляемую учетную запись, после перезагрузки сервера. Она вызвана тем, что служба распространения ключей Майкрософт не запускается после перезапуска Windows. При этом запустить службу или перезапустить Windows невозможно. Проблему можно воспроизвести по крайней мере на Windows Server 2012 R2. Чтобы решить эту проблему, выполните команду 

-   **sc triggerinfo kdssvc start/networkon**.

    Она запускает службу распространения ключей Майкрософт при наличии подключения к сети (обычно на ранних этапах цикла загрузки).

    Здесь вы найдете обсуждение аналогичной проблемы: <https://social.technet.microsoft.com/Forums/a290c5c0-3112-409f-8cb0-ff23e083e5d1/ad-fs-windows-2012-r2-adfssrv-hangs-in-starting-mode?forum=winserverDS>

4.  Запустите MSI с повышенными правами для службы MIM и выберите действие "Изменить".

5.  На странице "Настройка подключения к главному серверу" установите флажок "Использовать другую учетную запись для Exchange (для управляемых учетных записей)". Здесь вы можете указать старую учетную запись с любым почтовым ящиком или облачный почтовый ящик.

![](media/0cd8ce521ed7945c43bef6100f8eb222.png)

6.  На странице "Настройка учетной записи службы MIM" введите имя учетной записи службы с символом \$ в конце. Введите также пароль для учетной записи электронной почты. Пароль учетной записи службы должен быть отключен.

![](media/db0d543df6e1b0174a47135617c23fcb.png)

7.  Так как функция LogonUser не работает для управляемых учетных записей, на следующей странице вы увидите предупреждение "Убедитесь, что учетная запись службы защищена в текущей конфигурации".

![cid:image007.png\@01D36EB7.562E6CF0](media/d350bc13751b2d0a884620db072ed019.png)

8.  На странице "Настройка API REST для управления привилегированным доступом" введите имя учетной записи пула приложений с символом \$ в конце, а поле пароля оставьте пустым.

![](media/88db2f6f291fff8bcdd0da5d538aafc6.png)

9.  На странице "Настройка службы компонентов PAM" введите имя учетной записи службы с символом \$ в конце, а поле пароля оставьте пустым.

![](media/93cfbcefb4d17635dd35c5ead690fd1e.png)

![cid:image010.png\@01D36EB8.A295A3F0](media/9d2b52f6faed10601e7e2166a339fb47.png)

10.  На странице "Настройка службы мониторинга для управления привилегированным доступом" введите имя учетной записи службы с символом \$ в конце, а поле пароля оставьте пустым.

![](media/d1e824248edf12a77fc9ffb011475164.png)

11.  На странице "Настройка портала регистрации паролей MIM" введите имя учетной записи с символом \$ в конце, а поле пароля оставьте пустым.

![](media/601e935cdfda298b61ae753a2a152996.png)

12.  На странице "Настройка портала сброса паролей MIM" введите имя учетной записи с символом \$ в конце, а поле пароля оставьте пустым.

![](media/10c8cfa8ff2b6d703d14bd0b7ddc6949.png)

13.  Завершите установку.

Примечание.

-  После установки в реестре создаются два новых ключа в ветви
    - HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Forefront Identity
    - Manager\\2010\\Service, где будет храниться зашифрованный пароль Exchange. Один из ключей
    - предназначен для Exchange Online, а второй для локальной службы Exchange (один из них должен оставаться
    - пустым).

![cid:image014.jpg\@01D36F53.303D5190](media/73e2b8a3c149a4ec6bacb4db2c749946.jpg)

- Для обновления паролей мы предоставляет скрипт, который можно [скачать отсюда](microsoft-identity-manager-2016-gmsascript.md), чтобы пользователю не приходилось включать режим изменений.

- Чтобы зашифровать пароль Exchange, установщик создает дополнительную службу и
    - запускает ее от имени управляемой учетной записи. Следующие сообщения должны сохраняться
    - в журнал событий приложений в процессе установки.

![cid:image016.jpg\@01D36F53.303D5190](media/95b315454705cd4d939b55ac5ad910f5.jpg)
