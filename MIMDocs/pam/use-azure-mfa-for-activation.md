---
title: Использование Azure MFA для активации PAM | Документация Майкрософт
description: Настройте Azure MFA в качестве дополнительного уровня безопасности при активации ролей пользователями в Privileged Access Management.
keywords: ''
author: billmath
ms.author: billmath
ms.reviewer: fimguy
manager: mtillman
ms.date: 07/06/2018
ms.topic: article
ms.prod: microsoft-identity-manager
ms.assetid: 5134a112-f73f-41d0-a5a5-a89f285e1f73
ms.openlocfilehash: 9cb1e37f966db5c663694aaccd71f2b4c799dd4b
ms.sourcegitcommit: 44a2293ff17c50381a59053303311d7db8b25249
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2018
ms.locfileid: "50379945"
---
# <a name="using-azure-mfa-for-activation"></a>Использование Azure MFA для активации
> [!IMPORTANT]
> В соответствии с объявлением о прекращении поддержки пакета SDK для службы "Многофакторная идентификация Microsoft Azure" этот пакет SDK будет поддерживаться для существующих клиентов до даты прекращения использования — 14 ноября 2018 г. Новые и текущие клиенты больше не смогут скачать этот пакет SDK с классического портала. Чтобы скачать его, вам потребуется обратиться в службу поддержки клиентов Azure и получить созданный для вас пакет учетных данных службы MFA. <br> Группа разработки Майкрософт работает над интеграцией многофакторной идентификации с пакетом SDK для сервера MFA.  Эта возможность будет включена в очередное исправление. Следите за объявлениями в разделе с [историей версий](/reference/version-history.md). 


При настройке роли PAM можно выбрать порядок авторизации пользователей, запрашивающих активизацию роли. Авторизация PAM реализует следующие варианты:

- Утверждение владельца роли
- [Многофакторная идентификация Azure (MFA)](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication)

Если ни одна из проверок не включена, пользователи-кандидаты автоматически активируются для своих ролей.

Многофакторная проверка подлинности Microsoft Azure (MFA) — это служба проверки подлинности, которая требует, чтобы пользователи подтверждали вход с помощью мобильного приложения, звонка с мобильного телефона или текстового сообщения. Она доступна для использования с Microsoft Azure Active Directory, а также как служба для облачных и локальных корпоративных приложений. В сценарии PAM служба Azure MFA предоставляет дополнительный механизм проверки подлинности. Azure MFA можно использовать для авторизации независимо от того, как пользователь проходил проверку подлинности в домене Windows PRIV.

## <a name="prerequisites"></a>Предварительные условия

Для использования Azure MFA с MIM вам потребуется:

- Доступ к Интернету из каждой службы MIM, предоставляющей PAM, для связи со службой Azure MFA.
- Подписка Azure
- Лицензии Azure Active Directory Premium для пользователей-кандидатов или альтернативные средства лицензирования Azure MFA
- Номера телефонов всех пользователей-кандидатов

## <a name="creating-an-azure-mfa-provider"></a>Создание поставщика Azure MFA

В этом разделе вы настроите поставщик Azure MFA в Microsoft Azure Active Directory.  Если Azure MFA (автономная или через Azure Active Directory Premium) уже используется, перейдите к следующему разделу.

1.  Откройте веб-браузер и подключитесь к [классическому порталу Azure](https://manage.windowsazure.com) как администратор подписки Azure.

2.  В левом нижнем углу нажмите **Создать**.

3.  Выберите команды **Службы приложений > Active Directory > Поставщик многофакторной проверки подлинности > Быстрое создание**.

4.  В поле **Имя** введите **PAM**, а в поле "Модель использования" выберите "На включенного пользователя". Если у вас уже есть каталог Azure AD, выберите этот каталог. В конце нажмите кнопку **Создать**.

## <a name="downloading-the-azure-mfa-service-credentials"></a>Загрузка учетных данных службы Azure MFA

Теперь следует создать файл, включающий информацию для проверки подлинности, которая необходима PAM для подключения к серверу Azure MFA.

1. Откройте веб-браузер и подключитесь к [классическому порталу Azure](https://manage.windowsazure.com) как администратор подписки Azure.

2.  Выберите **Active Directory** в меню портала Azure и откройте вкладку **Поставщики многофакторной проверки подлинности** .

3.  Щелкните поставщик Azure MFA, который собираетесь использовать с PAM, а затем нажмите кнопку **Управление**.

4.  В левой области открывшегося окна в разделе **Настройка**нажмите **Параметры**.

5.  В окне **Azure Multi-Factor Authentication** выберите пакет **SDK** в разделе **Загрузки**.

6.  Щелкните ссылку **Скачать** в столбце ZIP для **пакета SDK для ASP.net 2.0 C#\#**.

![Загрузка пакета SDK Multi-Factor Authentication — снимок экрана](media/PAM-Azure-MFA-Activation-Image-1.png)

7.  Скопируйте полученный ZIP-файл на каждую систему, где установлена служба MIM. 

>[!NOTE]
> ZIP-файл содержит важную информацию, которая используется в службе Azure MFA.

## <a name="configuring-the-mim-service-for-azure-mfa"></a>Настройка службы MIM для Azure MFA

1.  Войдите на компьютер, где установлена служба MIM, в качестве администратора или пользователя, который установил службу.

2.  Создайте в каталоге установки службы MIM новую папку, например ```C:\Program Files\Microsoft Forefront Identity Manager\2010\Service\MfaCerts```.

3.  С помощью проводника Windows перейдите в папку ```pf\certs```, в которую вы скачали ZIP-файл на предыдущем шаге. Скопируйте файл ```cert\_key.p12``` в новый каталог.

4.  В проводнике Windows перейдите в папку ```pf``` с ZIP-файлом и откройте файл ```pf\_auth.cs``` в текстовом редакторе, например Wordpad.

5. Найдите следующие три параметра: ```LICENSE\_KEY```, ```GROUP\_KEY```, ```CERT\_PASSWORD```.

![Скопируйте значения из файла pf\_auth.cs — снимок экрана](media/PAM-Azure-MFA-Activation-Image-2.png)

6. Используя Блокнот, откройте файл **MfaSettings.xml**, расположенный в папке ```C:\Program Files\Microsoft Forefront Identity Manager\2010\Service```.

7. Скопируйте значения параметров LICENSE\_KEY, GROUP\_KEY и CERT\_PASSWORD из файла pf\_auth.cs в соответствующие XML-элементы файла MfaSettings.xml.

8. В XML-элементе **<CertFilePath>** укажите полный путь файла cert\_key.p12, извлеченного ранее.

9. В элементе **<username>** введите любое имя пользователя.

10. В элементе **<DefaultCountryCode>** введите код страны для набора телефонных номеров пользователей (например, 1 для США и Канады). Это значение используется в случае, если пользователи зарегистрированы с помощью телефонных номеров, в которых отсутствует код страны. Если код страны в номере телефона пользователя отличается от кода страны, заданного для организации, этот код страны следует включить в регистрируемый номер телефона.

11. Сохраните и перезапишите файл **MfaSettings.xml** в папке службы MIM ```C:\Program Files\Microsoft Forefront Identity Manager\2010\\Service```.

> [!NOTE]
> В конце процесса убедитесь, что к файлу **MfaSettings.xml**, всем его копиям и используемому ZIP-файлу не предоставлен общий доступ для чтения.

## <a name="configure-pam-users-for-azure-mfa"></a>Настройка пользователей PAM для многофакторной проверки подлинности Azure

Чтобы пользователь мог активировать роль, требующую Azure MFA, его номер телефона должен храниться в MIM. Этот атрибут можно задать двумя способами.

Первый способ: команда `New-PAMUser` копирует атрибут номера телефона из записи каталога пользователя в домен CORP, в базу данных службы MIM. Обратите внимание, что эта операция выполняется один раз.

Второй способ: команда `Set-PAMUser` обновляет атрибут номера телефона в базе данных службы MIM. Например, следующая команда заменит имеющийся номер телефона пользователя PAM в службе MIM. Запись в каталоге при этом не изменится.

```PowerShell
Set-PAMUser (Get-PAMUser -SourceDisplayName Jen) -SourcePhoneNumber 12135551212
```

## <a name="configure-pam-roles-for-azure-mfa"></a>Настройка ролей PAM для многофакторной проверки подлинности Azure

Когда телефонные номера всех пользователей-кандидатов для роли PAM будут сохранены в базе данных службы MIM, появится возможность настроить роли таким образом, чтобы многофакторная проверка подлинности Azure была обязательной. Для этого используются команды `New-PAMRole` и `Set-PAMRole`. Например,

```PowerShell
Set-PAMRole (Get-PAMRole -DisplayName "R") -MFAEnabled 1
```

Многофакторную проверку подлинности Azure можно отключить с помощью параметра "-MFAEnabled 0" в команде `Set-PAMRole`.

## <a name="troubleshooting"></a>Диагностика

В журнале событий управления привилегированным доступом можно найти следующие события:

| ID  | Статус | Создатель: | Описание |
|-----|----------|--------------|-------------|
| 101 | Ошибка       | Служба MIM            | Пользователь не завершил Azure MFA (например, не отвечает на телефонный звонок) |
| 103 | Данные | Служба MIM            | Пользователь завершил Azure MFA во время активации                       |
| 825 | Предупреждение     | Служба мониторинга PAM | Изменился номер телефона                                |

Чтобы получить дополнительные сведения о неудачных телефонных звонках (событие 101), можно просмотреть или загрузить отчет Azure MFA.

1.  Откройте веб-браузер и подключитесь к [классическому порталу Azure](https://manage.windowsazure.com) по адресу как глобальный администратор Azure AD.

2.  Выберите **Active Directory** в меню портала Azure и откройте вкладку **Поставщики многофакторной проверки подлинности** .

3.  Выберите поставщик Azure MFA, который используется с PAM, а затем нажмите кнопку **Управление**.

4.  В новом окне нажмите кнопку **Использование**, а затем **Сведения о пользователе**.

5.  Выберите диапазон времени и установите флажок рядом с полем **Имя** в столбце дополнительных отчетов. Нажмите кнопку **Экспорт в CSV**.

6.  После создания отчета его можно просмотреть на портале или, если отчет MFA слишком большой, загрузить в виде CSV-файла. Значения**SDK** в столбце **AUTH TYPE** обозначают строки, релевантные запросам на активацию PAM: это события, исходящие от MIM или другого локального программного обеспечения. Поле **USERNAME** в идентификаторе GUID объекта-пользователя в базе данных службы MIM. Если вызов был неудачным, в столбце **AUTHD** будет значение**Нет**, а значение в столбце **CALL RESULT** будет содержать подробные сведения о причине сбоя.

## <a name="next-steps"></a>Дальнейшие действия

- [Что такое Azure Multi-factor Authentication?](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication)
- [Создайте бесплатную учетную запись Azure уже сегодня](https://azure.microsoft.com/free/)
