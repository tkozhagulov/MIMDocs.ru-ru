---
title: Развертывание PAM. Шаг 1 — домен CORP | Документация Майкрософт
description: Подготовьте домен CORP при помощи существующего или нового удостоверения для управления диспетчером привилегированных удостоверений
keywords: ''
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 09/13/2017
ms.topic: article
ms.prod: microsoft-identity-manager
ms.assetid: 4b524ae7-6610-40a0-8127-de5a08988a8a
ms.reviewer: mwahl
ms.suite: ems
ms.openlocfilehash: dda6a05337e9a9778135fc7d833a38369540b3e0
ms.sourcegitcommit: 44a2293ff17c50381a59053303311d7db8b25249
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2018
ms.locfileid: "50379996"
---
# <a name="step-1---prepare-the-host-and-the-corp-domain"></a>Шаг 1. Подготовка узла и домена CORP

> [!div class="step-by-step"]
> [Шаг 2 "](step-2-prepare-priv-domain-controller.md)

В этом шаге описывается подготовка к размещению среды бастиона. При необходимости в новом домене и лесу (в лесу *CORP*) также создаются контроллер домена и участвующая рабочая станция с удостоверениями для управления средой бастиона. Этот лес CORP имитирует существующий лес, содержащий ресурсы, которыми нужно управлять. Этот документ содержит пример ресурсов для защиты — общую папку.

Если у вас уже есть домен Active Directory (AD) с контроллером домена под управлением Windows Server 2012 R2 или более поздней версии и вы являетесь его администратором, можете использовать этот домен.  

## <a name="prepare-the-corp-domain-controller"></a>Подготовка контроллера домена CORP

В этом разделе описывается настройка контроллера домена для домена CORP. В домене CORP административными пользователями управляет среда бастиона. В данном примере для домена CORP используется имя системы доменных имен (DNS) *contoso.local*.

### <a name="install-windows-server"></a>Установка Windows Server

Установите Windows Server 2012 R2 либо Windows Server 2016 Technical Preview 4 или более поздней версии на виртуальной машине, чтобы создать компьютер с именем *CORPDC*.

1. Выберите **Windows Server 2012 R2 Standard (сервер с графическим интерфейсом пользователя) x64** или **Windows Server 2016 Technical Preview (сервер с рабочим столом)**.

2. Просмотрите и примите условия лицензионного соглашения.

3. Поскольку диск будет пустым, выберите вариант **Выборочная: установка только Windows** и используйте неинициализированное дисковое пространство.

4. Войдите на новый компьютер от имени его администратора. Перейдите в "Панель управления". Задайте для компьютера имя *CORPDC* и назначьте ему статический IP-адрес в виртуальной сети. Перезагрузите сервер.

5. После перезагрузки сервера войдите от имени администратора. Перейдите в "Панель управления". Настройте компьютер для проверки обновлений и установите все необходимые обновления. Перезагрузите сервер.

### <a name="add-roles-to-establish-a-domain-controller"></a>Добавление ролей для установки контроллера домена

В этом разделе описывается добавление доменных служб Active Directory (AD DS), DNS-сервера и ролей файлового сервера (часть раздела "Службы файлов и хранения"), а также повышение роли сервера до контроллера домена в новом лесу contoso.local.

> [!NOTE]  
> Если у вас уже есть домен для использования в качестве домена CORP и этот домен применяет в качестве контроллера домена Windows Server 2012 R2 или более поздней версии, переходите к шагу [Создание дополнительных пользователей и групп для целей демонстрации](#create-additional-users-and-groups-for-demonstration-purposes).

1. Выполнив вход от имени администратора, запустите PowerShell.

2. Введите следующие команды:

   ```PowoerShell
   import-module ServerManager

   Add-WindowsFeature AD-Domain-Services,DNS,FS-FileServer –restart –IncludeAllSubFeature -IncludeManagementTools

   Install-ADDSForest –DomainMode Win2008R2 –ForestMode Win2008R2 –DomainName contoso.local –DomainNetbiosName contoso –Force -NoDnsOnNetwork
   ```

   Вам будет предложено ввести пароль администратора для безопасного режима. Обратит внимание, что появятся сообщения с предупреждениями для параметров делегирования DNS и криптографии. Это нормально.

3. После создания леса выйдите из системы. Сервер автоматически перезагрузится.

4. После перезагрузки сервера войдите в CORPDC как администратор домена. Обычно пароль, созданный при установке Windows в CORPDC, получает пользователь CONTOSO\\Administrator.

### <a name="create-a-group"></a>Создание группы

Создайте группу, которую будет аудировать Active Directory, если такая группа еще не существует. В качестве имени группы должно использоваться доменное имя NetBIOS с тремя знаками доллара, например *CONTOSO$$$*.

Для каждого домена войдите в контроллер домена с правами администратора домена и выполните следующие действия:

1. Запустите PowerShell.

2. Введите следующие команды, но вместо CONTOSO укажите имя NetBIOS домена.

   ```PowerShell
   import-module activedirectory

   New-ADGroup –name 'CONTOSO$$$' –GroupCategory Security –GroupScope DomainLocal –SamAccountName 'CONTOSO$$$'
   ```

В некоторых случаях группа может уже существовать — это нормально, если домен также использовался в сценариях миграции AD.

### <a name="create-additional-users-and-groups-for-demonstration-purposes"></a>Создание дополнительных пользователей и групп для целей демонстрации

При создании нового домена CORP необходимо также создать дополнительных пользователей и группы для демонстрации сценария PAM. Пользователь и группы для целей демонстрации не должны быть администраторами домена или управляться параметрами adminSDHolder в AD.

> [!NOTE]
> Если у вас уже есть домен, который будет применяться как домен CORP, и в этом домене есть пользователь и группа, которые можно использовать для целей демонстрации, можете пропустить этот шаг и перейти к разделу [Настройка аудита](#configure-auditing).

Мы собираемся создать группу безопасности с именем *CorpAdmins* и пользователя с именем *Jen*. При желании можете использовать другие имена.

1. Запустите PowerShell.

2. Введите следующие команды: Замените пароль Pass@word1 другим паролем.

   ```PowerShell
   import-module activedirectory

   New-ADGroup –name CorpAdmins –GroupCategory Security –GroupScope Global –SamAccountName CorpAdmins

   New-ADUser –SamAccountName Jen –name Jen

   Add-ADGroupMember –identity CorpAdmins –Members Jen

   $jp = ConvertTo-SecureString "Pass@word1" –asplaintext –force

   Set-ADAccountPassword –identity Jen –NewPassword $jp

   Set-ADUser –identity Jen –Enabled 1 -DisplayName "Jen"
   ```

### <a name="configure-auditing"></a>Настройка аудита

Необходимо включить аудит в существующих лесах, чтобы установить в них конфигурацию PAM.  

Для каждого домена войдите в контроллер домена с правами администратора домена и выполните следующие действия:

1. Откройте меню **Пуск** > **Средства администрирования** (или **Средства администрирования Windows** в Windows Server 2016) и запустите **Управление групповой политикой**.

2. Перейдите к политике контроллеров домена для данного домена.  Если вы создали домен для contoso.local, перейдите в раздел **Лес: contoso.local** > **Домены** > **contoso.local** > **Контроллеры доменов** > **Политика контроллеров доменов по умолчанию**. Это информационное сообщение.

3. Щелкните правой кнопкой мыши пункт **Политика контроллеров домена по умолчанию** и выберите команду **Изменить**. Появится новое окно.

4. В окне "Редактор управления групповыми политиками" в дереве "Политика контроллеров домена по умолчанию" перейдите к пункту **Настройка компьютера** > **Политики** > **Параметры Windows** > **Параметры безопасности** > **Локальные политики** > **Политики аудита**.

5. В области сведений щелкните правой кнопкой мыши пункт **Управление учетной записью аудита** и выберите пункт **Свойства**. Установите флажок **Определить следующие параметры политики**, флажки **Выполнено** и **Сбой**, нажмите кнопку **Применить**, а затем **ОК**.

6. В области сведений щелкните правой кнопкой мыши пункт **Доступ к службе каталогов аудита** и выберите пункт **Свойства**. Установите флажок **Определить следующие параметры политики**, флажки **Выполнено** и **Сбой**, нажмите кнопку **Применить**, а затем **ОК**.

7. Закройте окно редактора управления групповыми политиками и окно управления групповыми политиками.

8. Примените параметры аудита, открыв окно PowerShell и выполнив следующую команду:

   ```cmd
   gpupdate /force /target:computer
   ```

Через пару минут должно появиться сообщение **Обновление политики для компьютера успешно завершено**.

### <a name="configure-registry-settings"></a>Настройте параметры реестра

В этом разделе описывается настройка параметров реестра, которые потребуются для миграции журнала SID, который будет использоваться для создания группы управления привилегированным доступом.

1. Запустите PowerShell.

2. Введите следующие команды, которые настроят исходный домен, чтобы в нем разрешался удаленный вызов процедур (RPC) для доступа к базе данных диспетчера учетных записей служб (SAM).

   ```PowerShell
   New-ItemProperty –Path HKLM:SYSTEM\CurrentControlSet\Control\Lsa –Name TcpipClientSupport –PropertyType DWORD –Value 1

   Restart-Computer
   ```

Они перезапустят контроллер домена CORPDC. Дополнительные сведения об этом параметре реестра см. в статье [Устранение неполадок при миграции параметров sIDHistory между лесами с помощью средства ADMTv2](http://support.microsoft.com/kb/322970).

## <a name="prepare-a-corp-workstation-and-resource"></a>Подготовка рабочей станции и ресурсов CORP

Если у вас еще нет компьютера рабочей станции, подключенного к домену, подготовьте его, как описано ниже.  

> [!NOTE]
> Если у вас уже есть рабочая станция, подключенная к домену, пропустите этот шаг и перейдите к разделу [Создание ресурса для целей демонстрации](#create-a-resource-for-demonstration-purposes).

### <a name="install-windows-81-or-windows-10-enterprise-as-a-vm"></a>Установка Windows 8.1 или Windows 10 Enterprise как виртуальной машины

На еще одной виртуальной машине без установленного ПО установите Windows 8.1 Корпоративная или Windows 10 Корпоративная, чтобы создать компьютер *CORPWKSTN*.

1. При установке используйте экспресс-параметры.

2. Обратите внимание, что при установке может быть не установлено подключение к Интернету. Выберите параметр **Создать локальную учетную запись**. Укажите другое имя пользователя. Не используйте имена Administrator и Jen.

3. С помощью панели управления назначьте компьютеру статический IP-адрес в виртуальной сети и задайте для интерфейса такой же предпочитаемый DNS-сервер, как и для сервера CORPDC.

4. С помощью панели управления присоедините компьютер CORPWKSTN к домену contoso.local. Для этого потребуется предоставить учетные данные администратора домена Contoso. После завершения этого действия перезагрузите компьютер CORPWKSTN.

### <a name="create-a-resource-for-demonstration-purposes"></a>Создание ресурса для целей демонстрации

Вам потребуется ресурс для демонстрации управления доступом на основе групп безопасности с помощью PAM.  Если у вас еще нет ресурса, можете использовать для демонстрации папку с файлами.  В данном случае будут использоваться объекты AD Jen и CorpAdmins, созданные в вашем домене contoso.local.

1. Подключитесь к рабочей станции CORPWKSTN. Щелкните значок **Смена пользователя**, а затем **Другой пользователь**. Убедитесь, что пользователь CONTOSO\\Jen может войти на компьютер CORPWKSTN.

2. На компьютере CORPWKSTN создайте и сделайте общедоступной папку *CorpFS* с группой *CorpAdmins*.

3. Откройте PowerShell от имени администратора.

4. Введите следующие команды:

   ```PowerShell
   mkdir c:\corpfs

   New-SMBShare –Name corpfs –Path c:\corpfs –ChangeAccess CorpAdmins

   $acl = Get-Acl c:\corpfs

   $car = New-Object System.Security.AccessControl.FileSystemAccessRule( "CONTOSO\CorpAdmins", "FullControl", "Allow")

   $acl.SetAccessRule($car)

   Set-Acl c:\corpfs $acl
   ```

На следующем шаге описывается подготовка контроллера домена PRIV.

> [!div class="step-by-step"]
> [Шаг 2 "](step-2-prepare-priv-domain-controller.md)
