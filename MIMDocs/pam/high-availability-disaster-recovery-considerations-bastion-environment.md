---
title: Аварийное восстановление PAM | Документация Майкрософт
description: Сведения о настройке высокой доступности и аварийного восстановления для Privileged Access Management.
keywords: ''
author: barclayn
ms.author: barclayn
manager: mbaldwin
ms.date: 09/13/2017
ms.topic: article
ms.prod: microsoft-identity-manager
ms.technology: active-directory-domain-services
ms.assetid: 03e521cd-cbf0-49f8-9797-dbc284c63018
ms.reviewer: mwahl
ms.suite: ems
ms.openlocfilehash: 5af801ae3b5077d39bbe3957b0288e24c33ce551
ms.sourcegitcommit: ace4d997c599215e46566386a1a3d335e991d821
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2018
ms.locfileid: "49333961"
---
# <a name="high-availability-and-disaster-recovery-considerations-for-the-bastion-environment"></a>Рекомендации по обеспечению высокой доступности и аварийному восстановлению для среды бастиона

В этой статье описываются рекомендации по обеспечению высокой доступности и аварийному восстановлению для среды бастиона при развертывании доменных служб Active Directory (AD DS) и Microsoft Identity Manager 2016 (MIM) для управления привилегированным доступом.

Предприятия интересуют высокий уровень доступности и аварийное восстановление рабочих нагрузок в Windows Server, SQL Server и Active Directory. Также важна и доступность среды бастиона для управления привилегированным доступом. Среда бастиона занимает важное место в ИТ-инфраструктуре организации, поскольку пользователи взаимодействуют с ее компонентами, принимая административные роли. Для получения дополнительных сведений о высокой доступности в целом загрузите технический документ [Обзор высокого уровня доступности Microsoft](http://download.microsoft.com/download/3/B/5/3B51A025-7522-4686-AA16-8AE2E536034D/Microsoft%20High%20Availability%20Strategy%20White%20Paper.doc).

## <a name="high-availability-and-disaster-recovery-scenarios"></a>Сценарии высокой доступности и аварийного восстановления

При планировании высокого уровня доступности и аварийного восстановления необходимо учитывать следующее:

- Какие функции могут пострадать при простое?
- Какие функции являются критически важными для бизнеса и (или) ИТ-операций?
- Какие риски могут привести к простою этих систем?

От ответов на эти вопросы зависит общая стоимость развертывания и операций, в связи с чем организации могут ранжировать определенные функции выше других и принимать риски, связанные с временными сбоями менее значимых функций. В следующей таблице представлен пример ранжирования, которое может использоваться в организации:

| **Функция леса бастиона** | **Относительный приоритет в ходе восстановления** | **Меры при недоступности функции** |
| --------------------------- | --------------------- | -------------- |
| Установление доверия         | Низкая | Дождитесь восстановления среды бастиона |
| Перенос пользователей и групп   | Низкая | Дождитесь восстановления среды бастиона |
| Администрирование MIM          | Низкий | Дождитесь восстановления среды бастиона |
| Активация привилегированной роли  | Средняя | Выделенные резервные учетные записи со смарт-картами, позволяющие добавить пользователей в административные группы вручную |
| Управление ресурсами         | Высокий | Выделенные резервные учетные записи со смарт-картами, позволяющие добавить пользователей в административные группы вручную |
| Наблюдение за пользователями и группами в существующем лесу | Низкая | Дождитесь восстановления среды бастиона |

Теперь рассмотрим каждую из этих функций леса бастиона по очереди.

### <a name="trust-establishment"></a>Установление доверия

Между доменами существующего леса и леса среды бастиона должно быть установлено доверие леса. При этом пользователи, прошедшие проверки подлинности в среде бастиона, могут администрировать ресурсы в существующих лесах. Может потребоваться дополнительная настройка, например для того, чтобы разрешить перенос пользователей из существующих доменов в более ранних версиях Windows Server.

Для установления доверия требуются контроллеры домена в существующем лесу, подключенные к сети, а также компоненты MIM и AD среды бастиона.  Если при установлении доверия один из этих компонентов даст сбой, администратор сможет повторить операцию после того, как сбой будет устранен.  Если контроллеры домена в существующем лесу или среда бастиона восстанавливаются после сбоя, MIM включает также командлеты PowerShell `Test-PAMTrust` и `Test-PAMDomainConfiguration`, позволяющие проверить доверие.

### <a name="user-and-group-migration"></a>Перенос пользователей и групп

После установления доверия в среде бастиона можно создать теневые группы, а также учетные записи пользователей для членов этих групп и пользователей, утверждающих изменения. Таким образом, пользователи смогут активировать привилегированные роли и восстанавливать членство в группах.

Для уменьшения рисков для пользователей и групп требуются контроллеры домена в существующем лесу, подключенные к сети, а также компоненты MIM и AD среды бастиона.   Если контроллеры домена в существующем лесу недоступны, добавить пользователей и группы в среду бастиона нельзя, но на уже существующих пользователей и группы это не влияет. Если при уменьшении рисков один из компонентов даст сбой, администратор сможет повторить операцию после того, как сбой будет устранен.

### <a name="mim-administration"></a>Администрирование MIM

После переноса пользователей и групп администратор может также настроить в MIM назначения ролей, привязав пользователей как кандидатов на активацию в ролях.  Кроме того, они могут настроить политики MIM для утверждения и Azure MFA.  

Для администрирования MIM компоненты MIM и AD среды бастиона должны быть подключены к сети.

### <a name="privileged-role-activation"></a>Активация привилегированной роли

Если пользователь захочет активировать привилегированную роль, он должен будет пройти проверку подлинности в домене среды бастиона и отправить запрос в MIM.  MIM включает SOAP и API REST, а также пользовательские интерфейсы в PowerShell и на веб-странице.

Для активации привилегированной роли компоненты MIM и AD среды бастиона должны быть подключены к сети.  Кроме того, если MIM настроен для использования [многофакторной проверки подлинности Azure для активации](use-azure-mfa-for-activation.md) выбранной роли, для обращения к службе многофакторной проверки подлинности Azure требуется доступ к Интернету.

### <a name="resource-management"></a>Управление ресурсами

После того как пользователь будет успешно активирован в роли, контроллер домена может сгенерировать для него билет Kerberos, который смогут использовать контроллеры других доменов для идентификации временного членства пользователя в новых группах.

Для управления ресурсами требуется контроллер домена ресурсов, подключенный к сети, а также контроллер домена в среде бастиона.  Когда пользователь активирован, для выписки билета Kerberos больше не требуется, чтобы MIM или SQL в среде бастиона были подключены к сети.  (Обратите внимание на то, что если функциональным уровнем для среды бастиона служит Windows Server 2012 R2, для прекращения временного членства в группах MIM должен быть подключен к сети.)

### <a name="monitoring-of-users-and-groups-in-the-existing-forest"></a>Наблюдение за пользователями и группами в существующем лесу

MIM включает также службу мониторинга для управления привилегированным доступом, которая регулярно проверяет пользователей и группы в существующих доменах и вносит соответствующие изменения в базу данных MIM и AD.  Для активации роли и при управлении ресурсами подключение службы к сети не требуется.

Для мониторинга требуются контроллеры домена в существующем лесу, подключенные к сети, а также компоненты MIM и AD среды бастиона.  

## <a name="deployment-options"></a>Варианты развертывания

В статье [Обзор среды](environment-overview.md) иллюстрируется базовая топология, подходящая для изучения технологии, не предназначенной для обеспечения высокой доступности. В этом разделе описывается, как применять эту топологию для обеспечения высокой доступности в организациях, использующих один или несколько сайтов.

### <a name="networking"></a>Сеть

Сетевой трафик между компьютерами в среде бастиона необходимо изолировать от существующих сетей, например, с помощью отдельной физической или виртуальной сети.  В зависимости от рисков, существующих в среде бастиона, может также потребоваться установка независимых физических соединений между компьютерами.  Некоторые технологии отказоустойчивых кластеров предъявляют дополнительные требования к сетевым интерфейсам.

Компьютерам, на которых размещаются службы доменов Active Directory, и компьютерам со службами MIM в среде бастиона требуется двустороннее подключение к ресурсам в существующем лесу для:

- пользователей, которые будут проходить проверку подлинности с помощью контроллеров доменов леса PRIV;
- пользователей, запрашивающих активацию;
- пользователей для получения билетов Kerberos, которые будут использоваться ресурсами в существующем лесу;
- MIM для наблюдения за существующими доменами леса;
- MIM для отправки электронной почты через почтовые серверы, расположенные в существующем лесу.

### <a name="minimal-high-availability-topologies"></a>Минимальные топологии высокой доступности

Организация может выбрать, какие функции в среде бастиона должны отличаться высокой доступностью, с учетом следующих ограничений:

- Чтобы добиться высокой доступности какой-либо функции, предоставляемой средой бастиона, требуются как минимум два контроллера домена.  
- Чтобы добиться высокой доступности для запросов активации, требуются как минимум два компьютера, на которых размещается служба MIM, а также высокая доступность SQL Server.
- Для высокой доступности SQL Server с отказоустойчивыми кластерами требуются как минимум два сервера с SQL Server, причем контроллер домена должен быть установлен отдельно.
- Для уменьшения уязвимости серверов служба MIM и контроллер домена должны быть установлены на разных компьютерах.

Минимальная топология высокой доступности для всех функций в среде бастиона состоит по крайней мере из четырех серверов и общего хранилища. Два из этих серверов должны быть настроены как контроллеры доменов и предоставлять доменные службы Active Directory. Другие два сервера можно настроить как отказоустойчивый кластер, предоставляющий SQL Server, и как сервер, предоставляющий службу MIM.

Кроме того, типовое развертывание среды бастиона включает привилегированную рабочую станцию администратора для управления этими серверами, а также компонент мониторинга.

Одна из возможных архитектур представлена на следующей схеме:

![топология бастиона — схема](media/bastion1.png)

Для каждой из этих функций можно настроить дополнительные серверы, чтобы повысить производительность в условиях нагрузки или обеспечить географическую избыточность, как описано выше.

### <a name="deployments-supporting-multiple-sites"></a>Развертывание с поддержкой нескольких сайтов

Выбор правильной топологии для ресурсов, разворачиваемых на нескольких сайтах, зависит от трех факторов:

- Цели и риски, связанные с высокой доступностью и аварийным восстановлением
- Пригодность оборудования для размещения среды бастиона
- Модель административной работы для каждого сайта.

Один из самых простых вариантов — это разместить среду бастиона на определенном сайте.  В обычных условиях пользователи будут подключаться к развертыванию MIM в среде бастиона этого сайта и запрашивать активацию, которая, в свою очередь, будет затрагивать все ресурсы на каждом сайте.  Если сетевое подключение будет разорвано или сайт размещения среды бастиона окажется недоступен, учетные данные для автономного доступа можно будет временно использовать для выполнения административных задач на другом сайте, пока подключение к сети не восстановится.  Это может пригодиться в ситуациях, когда предполагается, что локальный администратор определенного сайта, например филиала, будет подключать этот сайт к остальной сети организации редко или в ограниченном объеме.

![Топология с одним бастионом для нескольких сайтов — схема](media/bastion2.png)

Для обеспечения высокой доступности и аварийного восстановления сайтов на каждом из них можно развернуть компоненты среды бастиона, используя общий каталог PRIV и единую базу данных SQL.  В такой топологии при разрыве сетевого подключения пользователи каждого сайта смогут продолжать работу независимо друг от друга.

![Топология с несколькими бастиона и несколькими сайтами — схема](media/bastion3.png)

При таком варианте развертывания возникает следующее ограничение: для SQL Server требуется кластер, охватывающий оба сайта, что может быть сложно для реализации. В этом случае в качестве альтернативы можно только реплицировать Active Directory (лес PRIV) среды бастиона.  При разрыве сетевого подключения между сайтами пользователи сайта Б, которые уже активировали свои привилегированные роли, смогут продолжить работу по управлению ресурсами администрирования на сайте Б.

![Топология реплицированного бастиона для нескольких сайтов — схема](media/bastion4.png)

Если каждый узел представляет отдельную административную границу, можно развернуть несколько независимых сред бастионов.  В каждой такой среде бастиона устанавливается одинаковое программное обеспечение, но доменные имена различаются, поэтому ничего общего между каталогами и базами данных каждой среды бастиона нет. Пользователь, который хочет управлять ресурсами на определенном сайте, должен будет активировать учетную запись в среде бастиона на этом сайте.

![Топология и независимыми бастионами для нескольких сайтов — схема](media/bastion5.png)

Развертывания могут быть еще более сложными, поскольку для управления ресурсами в определенном домене можно настроить несколько независимых сред бастионов.

![Топология с комплексным бастионом для нескольких сайтов — схема](media/bastion6.png)

### <a name="hosted-bastion-environment"></a>Размещенная среда бастиона

Некоторые организации рассматривают также создание среды бастиона отдельно от всех существующих сайтов. Программное обеспечение среды бастиона может размещаться на платформе визуализации либо в сетях организации, либо на сервере внешнего поставщика услуг размещения.  Рассматривая этот вариант, учитывайте следующие факторы:

- Чтобы защититься от атак, исходящих из существующих доменов, администрирование среды бастиона необходимо изолировать от административных учетных записей существующего домена.
- Среда бастиона должна быть подключена к контроллерам существующего домена по протоколу TCP/IP.  Список портов см. в статье [Настройка брандмауэра для установления доверительных отношений между доменами](https://support.microsoft.com/kb/179442).
- Виртуализированное развертывание доменных служб Active Directory требует определенных функций платформы виртуализации, как описано в статье [Развертывание и настройка виртуализированного контроллера домена](https://technet.microsoft.com/library/jj574223.aspx).
- Развертывание высокой доступности SQL Server для службы MIM требует особой настройки хранилища, описанной ниже в разделе [Хранилище базы данных SQL Server](#sql-server-database-storage).  В настоящее время не все поставщики услуг размещения могут предложить размещение для Windows Server с настройками дисков, подходящими для отказоустойчивых кластеров SQL Server.

## <a name="deployment-preparation-and-recovery-procedures"></a>Процедуры подготовки развертывания и восстановления

При подготовке развертывания среды бастиона с поддержкой высокой доступности и аварийного восстановления необходимо учитывать порядок установки Windows Server Active Directory, SQL Server и его базы данных в общем хранилище, а также службы MIM и соответствующих компонентов управления привилегированным доступом.

### <a name="windows-server"></a>Windows Server

Windows Server имеет встроенную функцию обеспечения высокой доступности, обеспечивающую совместную работу нескольких компьютеров как отказоустойчивого кластера. Кластерные серверы соединены физическими кабелями и программным обеспечением. При сбое на одном из узлов кластера его функции немедленно передаются другим узлам (этот процесс называется отработкой отказа).   Дополнительные сведения см. в статье [Обзор отказоустойчивой кластеризации](https://technet.microsoft.com/library/hh831579.aspx).

Убедитесь, что операционная система и приложения в среде бастиона получают обновления безопасности. Некоторые из таких обновлений могут требовать перезагрузки сервера, поэтому во избежание длительных простоев необходимо координировать время применения обновлений между серверами. Один из способов — использовать [кластерное обновление](https://technet.microsoft.com/library/hh831694.aspx) для серверов в отказоустойчивом кластере Windows Server.

Серверы в среде бастиона будут подключены к домену и зависимы от доменных служб. Убедитесь, что эти серверы не были случайно настроены с зависимостью от определенного контроллера домена для таких служб, как DNS.

### <a name="bastion-environment-active-directory"></a>Active Directory среды бастиона

Доменные службы Windows Server Active Directory изначально включают поддержку высокой доступности и аварийного восстановления.

#### <a name="preparation"></a>Подготовка

Типовое рабочее развертывание управления привилегированным доступом включает не менее двух контроллеров домена для среды бастиона. Инструкции по настройке первого контроллера домена в среде бастиона описаны на шаге 2 в статье о развертывании [Подготовка контроллера домена PRIV](step-2-prepare-priv-domain-controller.md).

Процедура добавления дополнительного контроллера домена описывается в статье [Установка реплики контроллера домена Windows Server 2012 в существующем домене (уровень 200)](https://technet.microsoft.com/library/jj574134.aspx).  

>[!NOTE]
> Если контроллер домена будет размещаться на платформе виртуализации, например, как Hyper-V, изучите предупреждения в статье [Развертывание и настройка виртуализированного контроллера домена](https://technet.microsoft.com/library/jj574223.aspx).

#### <a name="recovery"></a>Модель

Прежде чем перезапускать серверы после сбоя, убедитесь в том, что в среде бастиона доступен хотя бы один контроллер домена.

В пределах домена Active Directory распространяет между контроллерами домена роли гибких операций с единым хозяином (FSMO), как описано в статье [Принцип работы хозяев операций](https://technet.microsoft.com/library/cc780487.aspx).  При сбое контроллера может потребоваться перевод одной или нескольких [ролей контроллера домена](https://technet.microsoft.com/library/cc786438.aspx), назначенных контроллеру домена.

Установив, что контроллер домена не будет возвращен в работу, проверьте, назначены ли этому контроллеру какие-либо роли, и переназначьте их, если нужно. Инструкции см. на странице [Просмотр текущих владельцев ролей хозяев операций](https://technet.microsoft.com/library/cc816893.aspx) и в связанных с ней статьях.

Рекомендуется проверять параметры DNS компьютеров, подключенных к среде бастиона, а также контроллеры доменов CORP, имеющих доверительные отношения с контроллером домена, и следить за тем, чтобы ни для одного из них не была жестко задана зависимость от IP-адреса компьютера соответствующего контроллера домена.

### <a name="sql-server-database-storage"></a>Хранилище базы данных SQL Server

Для развертывания высокой доступности требуются отказоустойчивые кластеры SQL Server и отказоустойчивые кластеры SQL Server, требующие ответа общего хранилища для всех узлов, для хранения базы данных и журнала. Общее хранилище может иметь форму дисков отказоустойчивой кластеризации Windows Server, дисков в сети хранения данных (SAN) или общих папок на сервере SMB.  Обратите внимание, что хранилище должно быть выделено для среды бастиона; не рекомендуется одновременно использовать его для других рабочих нагрузок за пределами среды бастиона, поскольку это может нарушить ее целостность.

### <a name="sql-server"></a>SQL Server

Для службы MIM необходимо развернуть SQL Server в среде бастиона.   Для обеспечения высокой доступности SQL можно развернуть, используя экземпляр отказоустойчивого кластера (FCI). В отличие от автономных экземпляров в FCI высокая доступность SQL Server обеспечивается наличием избыточных узлов в экземпляре отказоустойчивого кластера. В случае сбоя или планового ремонта владение группой ресурсов перейдет к другому узлу отказоустойчивого кластера Windows Server.

Если поддержка необходима только для аварийного восстановления, а высокая доступность не требуется, вместо отказоустойчивой кластеризации можно использовать доставку журналов, репликацию транзакций или снимков экрана либо зеркальное отображение базы данных.   

#### <a name="preparation"></a>Подготовка

SQL Server, устанавливаемый в среде бастиона, должен быть независим от SQL Server, который уже присутствует в лесах CORP.  Кроме того, SQL Server рекомендуется развертывать на выделенном сервере отдельно от контроллера домена.
Дополнительные сведения см. в руководстве по SQL Server для [экземпляров отказоустойчивого кластера AlwaysOn](https://msdn.microsoft.com/library/ms189134.aspx).

#### <a name="recovery"></a>Модель

Если SQL Server был настроен для аварийного восстановления с использованием доставки журналов, в ходе восстановления необходимо выполнять действие по обновлению SQL Server.  Более того, требуется перезагрузка экземпляра службы MIM.

При сбое SQL Server или потере соединения между SQL Server и службой MIM и последующем восстановлении SQL Server каждую службу MIM рекомендуется перезапустить.  Это позволит восстановить подключение службы MIM к SQL Server.

### <a name="mim-service"></a>Служба MIM
Служба MIM должна обрабатывать запросы на активацию.  Для того чтобы компьютер, на котором установлена служба MIM, можно было отключать для ремонта, не теряя возможности обработки запросов на активацию, можно развернуть несколько компьютеров со службой MIM.  Обратите внимание на то, что после добавления пользователя в группу служба MIM в операциях Kerberos не участвует.  

#### <a name="preparation"></a>Подготовка
Службу MIM рекомендуется разворачивать на нескольких серверах, подключенных к домену PRIV.
Информацию о высокой доступности см. в документации к Windows Server — [Требования к оборудованию для отказоустойчивой кластеризации и варианты хранилища](https://technet.microsoft.com/library/jj612869.aspx) и [Создание отказоустойчивого кластера Windows Server 2012](http://blogs.msdn.com/b/clustering/archive/2012/05/01/10299698.aspx).

Для рабочего развертывания на нескольких серверах можно использовать подсистему балансировки сетевой нагрузки (NLB).  Кроме того, потребуется общий псевдоним (например, A для записей CNAME), чтобы пользователь видел одно и то же имя.

>[!IMPORTANT]
> Если используется технология балансировки нагрузки, отличная от подсистемы балансировки сетевой нагрузки в Windows Server 2012 R2, убедитесь, что решение будет перенаправлять один сеанс на один и тот же, а не на случайный сервер.

При развертывании MIM с несколькими серверами каждая служба MIM получает имя внешнего узла, имя службы и имя раздела службы.  По умолчанию именем службы является имя компьютера, а имя внешнего узла и имя раздела службы настраиваются при установке службы MIM на экране, где запрашивается адрес сервера службы MIM. Все три имени хранятся в файле %ProgramFiles%\Microsoft Forefront Identity Manager\Service\Microsoft.ResourceManagementService.exe.config как атрибуты `externalHostName`, `serviceName` и `servicePartitionName` узла конфигурации `resourceManagementService`.  

Когда служба MIM получает запрос, имя раздела службы сохраняется как атрибут этого запроса.   Как следствие, взаимодействовать с этим запросом могут только те установки службы MIM, в который используется то же имя раздела службы.  Таким образом, если сценарий управления привилегированным доступом включает утверждение вручную или другие долгосрочные процедуры обработки запросов, у каждой службы MIM должен быть такой же атрибут `servicePartitionName`, как в файле конфигурации.

#### <a name="recovery"></a>Модель

Перед повторным запуском службы MIM после сбоя убедитесь, что в среде бастиона имеется хотя бы один контроллер домена Active Directory и SQL Server.  

Экземпляр рабочего потока может быть завершен только тем сервером службы MIM, у которого имя раздела службы и имя службы совпадают с аналогичными параметрами сервера службы MIM, который его запустил.  Если сбой происходит на компьютере со службой MIM, когда та обрабатывала запросы, и этот компьютер не возвращается службе MIM, ее необходимо установить на новом компьютере. После установки новой службы MIM измените файл *resourcemanagementservice.exe.config* и задайте атрибуты `serviceName` и `servicePartitionName` нового развертывания MIM таким образом, чтобы они совпадали с именем узла и именем раздела службы отказавшего компьютера.

### <a name="mim-pam-components"></a>Компоненты управления привилегированным доступом в службе MIM

Установщик службы и портала MIM также включает дополнительные компоненты управления привилегированным доступом, включая модули PowerShell и две службы.

#### <a name="preparation"></a>Подготовка

Компоненты управления привилегированным доступом должны быть установлены на каждом компьютере в среде бастиона, где установлена служба MIM.  Добавить их позже нельзя.

#### <a name="recovery"></a>Модель

Выполнив восстановление после сбоя, убедитесь, что служба MIM запущена хотя бы на одном сервере.  Убедитесь, что служба мониторинга управления привилегированным доступом MIM также запущена на этом сервере, с помощью `net start "PAM Monitoring service"`.

Если лес среды бастиона имеет функциональный уровень Windows Server 2012 R2, убедитесь, что компонент службы управления привилегированным доступом MIM также запущен на этом сервере, с помощью команды `net start "PAM Component service"`.
